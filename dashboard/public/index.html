<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vulcan E-Commerce Test Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .vulcan-gradient { background: linear-gradient(135deg, #003087 0%, #0066CC 100%); }
        .vulcan-blue { color: #003087; }
        .vulcan-blue-bg { background-color: #003087; }
        .vulcan-blue-light { background-color: #0066CC; }
        .vulcan-border { border-color: #003087; }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,48,135,0.2); }
        .pulse-dot { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .log-line { font-family: 'Courier New', monospace; font-size: 13px; }
        .modal-backdrop { backdrop-filter: blur(4px); }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-pass { background-color: #d4edda; color: #155724; border: 1px solid #28a745; }
        .status-fail { background-color: #f8d7da; color: #721c24; border: 1px solid #dc3545; }
        .status-running { background-color: #fff3cd; color: #856404; border: 1px solid #ffc107; }
        .status-ready { background-color: #d1ecf1; color: #0c5460; border: 1px solid #0066CC; }
        .status-passed { background-color: #d4edda; color: #155724; border: 1px solid #28a745; }
        .status-failed { background-color: #f8d7da; color: #721c24; border: 1px solid #dc3545; }
        .line-clamp-2 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
            line-clamp: 2;
        }
        .vulcan-button {
            background: linear-gradient(135deg, #003087 0%, #0066CC 100%);
            color: white;
            transition: all 0.3s ease;
        }
        .vulcan-button:hover:not(:disabled) {
            background: linear-gradient(135deg, #0066CC 0%, #003087 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,48,135,0.3);
        }
        .vulcan-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // API Base URL
        const API_BASE = 'http://localhost:3001/api';

        // ============ SIDEBAR COMPONENT ============
        function Sidebar({ activeTab, onTabChange }) {
            const menuItems = [
                { id: 'modules', label: 'Modules', icon: '‚äû' },
                { id: 'execution', label: 'Execution', icon: '‚ñ∂' },
                { id: 'analytics', label: 'Analytics', icon: 'üìä' },
                { id: 'report', label: 'Executive Report', icon: 'üìã' },
                { id: 'ai', label: 'AI Commander', icon: 'ü§ñ' },
                { id: 'ai-features', label: 'AI Feature Generator', icon: '‚ú®' },
                { id: 'defects', label: 'Defects', icon: '‚ö†' },
            ];

            return (
                <aside className="w-64 vulcan-blue-bg text-white flex flex-col shadow-xl">
                    <div className="p-6 border-b border-blue-800">
                        <div className="flex items-center space-x-3">
                            <div className="w-10 h-10 bg-white rounded-lg flex items-center justify-center">
                                <span className="text-2xl font-bold vulcan-blue">V</span>
                            </div>
                            <div>
                                <h2 className="text-lg font-semibold">Vulcan</h2>
                                <p className="text-xs text-blue-200">Test Dashboard</p>
                            </div>
                        </div>
                    </div>
                    
                    <nav className="flex-1 p-4 space-y-2">
                        {menuItems.map((item) => {
                            const isActive = activeTab === item.id;
                            return (
                                <button
                                    key={item.id}
                                    onClick={() => onTabChange(item.id)}
                                    className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-all ${
                                        isActive 
                                            ? 'bg-blue-600' 
                                            : 'hover:bg-blue-700/50'
                                    }`}
                                >
                                    <span className="text-xl">{item.icon}</span>
                                    <span className="font-medium text-sm">{item.label}</span>
                                </button>
                            );
                        })}
                    </nav>
                    
                    <div className="p-4 border-t border-blue-800">
                        <div className="text-xs text-blue-200 space-y-1">
                            <p className="flex items-center space-x-2">
                                <span className="w-2 h-2 bg-green-400 rounded-full pulse-dot"></span>
                                <span>Framework v1.0.0</span>
                            </p>
                            <p>Jira: Connected</p>
                            <p>Environment: QA</p>
                        </div>
                    </div>
                </aside>
            );
        }

        // ============ HEADER COMPONENT ============
        function Header() {
            return (
                <header className="vulcan-gradient text-white shadow-lg">
                    <div className="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
                        <div className="flex items-center space-x-3">
                            <div className="w-10 h-10 bg-white rounded-lg flex items-center justify-center">
                                <span className="text-2xl font-bold vulcan-blue">V</span>
                            </div>
                            <div>
                                <h1 className="text-2xl font-bold">Vulcan Materials</h1>
                                <p className="text-blue-100 text-sm">E-Commerce Test Automation Dashboard</p>
                            </div>
                        </div>
                        <div className="flex items-center space-x-4">
                            <div className="flex items-center space-x-2 bg-white/10 px-4 py-2 rounded-lg border border-white/20">
                                <div className="w-2 h-2 bg-green-400 rounded-full pulse-dot"></div>
                                <span className="text-sm">QA Environment</span>
                            </div>
                        </div>
                    </div>
                </header>
            );
        }

        // ============ MODULES TAB COMPONENT ============
        function ModulesTab({ modules, stats, loading, onRunTests, onViewScenarios }) {
            const [selectedPriorities, setSelectedPriorities] = useState([]);
            const [selectedTags, setSelectedTags] = useState([]);
            const [runningPriorityTests, setRunningPriorityTests] = useState(false);

            const toggleTag = (tag) => {
                if (selectedTags.includes(tag)) {
                    setSelectedTags(selectedTags.filter(t => t !== tag));
                } else {
                    setSelectedTags([...selectedTags, tag]);
                }
            };

            const togglePriority = (priority) => {
                if (selectedPriorities.includes(priority)) {
                    setSelectedPriorities(selectedPriorities.filter(p => p !== priority));
                } else {
                    setSelectedPriorities([...selectedPriorities, priority]);
                }
            };

            const handleRunSelectedTests = async () => {
                const allTags = [...selectedTags, ...selectedPriorities];
                
                if (allTags.length === 0) {
                    alert('Please select at least one tag or priority');
                    return;
                }

                setRunningPriorityTests(true);
                try {
                    const tags = allTags.map(t => `@${t}`).join(' or ');
                    const response = await fetch(`${API_BASE}/tests/run`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            modules: modules.map(m => m.id),
                            headless: true,
                            tags: tags
                        })
                    });

                    const data = await response.json();
                    
                    // Switch to execution tab
                    if (data.executionId) {
                        window.dispatchEvent(new CustomEvent('startExecution', { detail: data.executionId }));
                    }
                    
                    alert(`Started execution for ${allTags.join(', ')} tests. Execution ID: ${data.executionId}`);
                } catch (error) {
                    console.error('Error starting tests:', error);
                    alert('Failed to start test execution');
                } finally {
                    setRunningPriorityTests(false);
                }
            };

            const getTagCount = (tag) => {
                if (!stats || !stats.tagBreakdown) return 0;
                return stats.tagBreakdown[tag.toLowerCase()] || 0;
            };

            const getPriorityCount = (priority) => {
                if (!stats || !stats.priorityBreakdown) return 0;
                return stats.priorityBreakdown[priority.toLowerCase()] || 0;
            };

            if (loading) {
                return (
                    <div className="flex items-center justify-center h-full">
                        <div className="text-center">
                            <div className="w-16 h-16 border-4 border-blue-700 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                            <p className="text-gray-600 font-semibold">Loading modules...</p>
                        </div>
                    </div>
                );
            }

            const hasSelection = selectedTags.length > 0 || selectedPriorities.length > 0;

            return (
                <div className="max-w-7xl mx-auto px-6 py-8">
                    {/* Quick Execution Selection */}
                    <div className="bg-white rounded-xl shadow-md p-6 mb-8 border-l-4 border-blue-700">
                        <div className="flex items-start justify-between mb-6">
                            <div className="flex-1">
                                <h3 className="text-lg font-bold text-gray-800 mb-2 flex items-center">
                                    <span className="text-2xl mr-2">‚ö°</span>
                                    Quick Execution Selection
                                </h3>
                                <p className="text-sm text-gray-600">
                                    Select test suites or priority levels to execute scenarios across all modules
                                </p>
                            </div>
                            {hasSelection && (
                                <button
                                    onClick={handleRunSelectedTests}
                                    disabled={runningPriorityTests}
                                    className="vulcan-button px-8 py-3 rounded-lg font-semibold flex items-center space-x-2 shadow-lg"
                                >
                                    {runningPriorityTests ? (
                                        <>
                                            <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                            <span>Starting...</span>
                                        </>
                                    ) : (
                                        <>
                                            <span>‚ñ∂</span>
                                            <span>Run Selected Tests</span>
                                        </>
                                    )}
                                </button>
                            )}
                        </div>

                        {/* Test Type Selection (Regression/Sanity) */}
                        <div className="mb-6">
                            <div className="text-xs font-semibold text-gray-500 uppercase mb-3">Test Suites</div>
                            <div className="flex items-center space-x-3">
                                {/* Regression */}
                                <button
                                    onClick={() => toggleTag('Regression')}
                                    className={`flex flex-col items-center justify-center px-8 py-4 rounded-lg border-2 transition-all ${
                                        selectedTags.includes('Regression')
                                            ? 'border-blue-700 bg-blue-50 shadow-md ring-2 ring-blue-300'
                                            : 'border-blue-300 bg-white hover:border-blue-400 hover:shadow'
                                    }`}
                                >
                                    <div className="flex items-center space-x-2 mb-1">
                                        <div className="w-3 h-3 rounded-full bg-blue-700"></div>
                                        <span className="font-bold text-blue-700">Regression</span>
                                        {selectedTags.includes('Regression') && (
                                            <span className="text-green-600 text-lg">‚úì</span>
                                        )}
                                    </div>
                                    <span className="text-xs text-gray-500">{getTagCount('Regression')} scenarios</span>
                                    {stats?.estimatedExecutionTime?.regression && (
                                        <span className="text-xs text-blue-600 font-semibold mt-1">‚è± ~{stats.estimatedExecutionTime.regression}</span>
                                    )}
                                </button>

                                {/* Sanity */}
                                <button
                                    onClick={() => toggleTag('Sanity')}
                                    className={`flex flex-col items-center justify-center px-8 py-4 rounded-lg border-2 transition-all ${
                                        selectedTags.includes('Sanity')
                                            ? 'border-green-600 bg-green-50 shadow-md ring-2 ring-green-300'
                                            : 'border-green-300 bg-white hover:border-green-400 hover:shadow'
                                    }`}
                                >
                                    <div className="flex items-center space-x-2 mb-1">
                                        <div className="w-3 h-3 rounded-full bg-green-600"></div>
                                        <span className="font-bold text-green-600">Sanity</span>
                                        {selectedTags.includes('Sanity') && (
                                            <span className="text-green-600 text-lg">‚úì</span>
                                        )}
                                    </div>
                                    <span className="text-xs text-gray-500">{getTagCount('Sanity')} scenarios</span>
                                    {stats?.estimatedExecutionTime?.sanity && (
                                        <span className="text-xs text-green-600 font-semibold mt-1">‚è± ~{stats.estimatedExecutionTime.sanity}</span>
                                    )}
                                </button>
                            </div>
                        </div>

                        {/* Priority Selection */}
                        <div>
                            <div className="text-xs font-semibold text-gray-500 uppercase mb-3">Priority Levels</div>
                            <div className="flex items-center space-x-3">
                                {/* P1 Priority */}
                                <button
                                    onClick={() => togglePriority('P1')}
                                    className={`flex flex-col items-center justify-center px-6 py-4 rounded-lg border-2 transition-all ${
                                        selectedPriorities.includes('P1')
                                            ? 'border-red-600 bg-red-50 shadow-md ring-2 ring-red-300'
                                            : 'border-red-300 bg-white hover:border-red-400 hover:shadow'
                                    }`}
                                >
                                    <div className="flex items-center space-x-2 mb-1">
                                        <div className="w-3 h-3 rounded-full bg-red-600"></div>
                                        <span className="font-bold text-red-600">P1</span>
                                        {selectedPriorities.includes('P1') && (
                                            <span className="text-green-600 text-lg">‚úì</span>
                                        )}
                                    </div>
                                    <span className="text-xs text-gray-500">{getPriorityCount('P1')} scenarios</span>
                                    {stats?.estimatedExecutionTime?.p1 && (
                                        <span className="text-xs text-red-600 font-semibold mt-1">‚è± ~{stats.estimatedExecutionTime.p1}</span>
                                    )}
                                </button>

                                {/* P2 Priority */}
                                <button
                                    onClick={() => togglePriority('P2')}
                                    className={`flex flex-col items-center justify-center px-6 py-4 rounded-lg border-2 transition-all ${
                                        selectedPriorities.includes('P2')
                                            ? 'border-orange-600 bg-orange-50 shadow-md ring-2 ring-orange-300'
                                            : 'border-orange-300 bg-white hover:border-orange-400 hover:shadow'
                                    }`}
                                >
                                    <div className="flex items-center space-x-2 mb-1">
                                        <div className="w-3 h-3 rounded-full bg-orange-600"></div>
                                        <span className="font-bold text-orange-600">P2</span>
                                        {selectedPriorities.includes('P2') && (
                                            <span className="text-green-600 text-lg">‚úì</span>
                                        )}
                                    </div>
                                    <span className="text-xs text-gray-500">{getPriorityCount('P2')} scenarios</span>
                                    {stats?.estimatedExecutionTime?.p2 && (
                                        <span className="text-xs text-orange-600 font-semibold mt-1">‚è± ~{stats.estimatedExecutionTime.p2}</span>
                                    )}
                                </button>

                                {/* P3 Priority */}
                                <button
                                    onClick={() => togglePriority('P3')}
                                    className={`flex flex-col items-center justify-center px-6 py-4 rounded-lg border-2 transition-all ${
                                        selectedPriorities.includes('P3')
                                            ? 'border-blue-600 bg-blue-50 shadow-md ring-2 ring-blue-300'
                                            : 'border-blue-300 bg-white hover:border-blue-400 hover:shadow'
                                    }`}
                                >
                                    <div className="flex items-center space-x-2 mb-1">
                                        <div className="w-3 h-3 rounded-full bg-blue-600"></div>
                                        <span className="font-bold text-blue-600">P3</span>
                                        {selectedPriorities.includes('P3') && (
                                            <span className="text-green-600 text-lg">‚úì</span>
                                        )}
                                    </div>
                                    <span className="text-xs text-gray-500">{getPriorityCount('P3')} scenarios</span>
                                    {stats?.estimatedExecutionTime?.p3 && (
                                        <span className="text-xs text-blue-600 font-semibold mt-1">‚è± ~{stats.estimatedExecutionTime.p3}</span>
                                    )}
                                </button>
                            </div>
                        </div>

                        {/* Selection Summary */}
                        {hasSelection && (
                            <div className="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                <span className="text-sm font-semibold text-blue-800">
                                    Selected: {[...selectedTags, ...selectedPriorities].join(', ')}
                                </span>
                            </div>
                        )}
                    </div>

                    {/* Stats Section */}
                    {stats && (
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                            <div className="bg-white rounded-xl shadow-md p-6 border-l-4 border-gray-400">
                                <div className="text-gray-500 text-xs mb-2 font-semibold">TOTAL MODULES</div>
                                <div className="text-3xl font-bold text-gray-800">{stats.totalModules}</div>
                            </div>
                            <div className="bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-700">
                                <div className="text-gray-500 text-xs mb-2 font-semibold">TOTAL SCENARIOS</div>
                                <div className="text-3xl font-bold vulcan-blue">{stats.totalScenarios}</div>
                            </div>
                            <div className="bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500">
                                <div className="text-gray-500 text-xs mb-2 font-semibold">JIRA STORIES</div>
                                <div className="text-3xl font-bold text-blue-600">{stats.totalJiraStories}</div>
                            </div>
                            <div className="bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500">
                                <div className="text-gray-500 text-xs mb-2 font-semibold">PRIORITY BREAKDOWN</div>
                                <div className="flex space-x-2 mt-2">
                                    <span className="text-sm font-bold text-red-600">P1: {stats.priorityBreakdown.p1}</span>
                                    <span className="text-sm font-bold text-orange-600">P2: {stats.priorityBreakdown.p2}</span>
                                    <span className="text-sm font-bold text-green-600">P3: {stats.priorityBreakdown.p3}</span>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modules Grid */}
                    <div className="mb-6">
                        <h2 className="text-2xl font-bold text-gray-800 mb-4">Test Modules</h2>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {modules.map(module => (
                            <ModuleCard 
                                key={module.id}
                                module={module}
                                onRunTests={onRunTests}
                                onViewScenarios={onViewScenarios}
                            />
                        ))}
                    </div>
                </div>
            );
        }

        // ============ MODULE CARD COMPONENT ============
        function ModuleCard({ module, onRunTests, onViewScenarios }) {
            const [showPrioritySelector, setShowPrioritySelector] = useState(false);
            const [selectedModulePriorities, setSelectedModulePriorities] = useState([]);
            
            const priorityColors = {
                p1: { bg: 'bg-red-50', border: 'border-red-500', text: 'text-red-700', dot: 'bg-red-500' },
                p2: { bg: 'bg-orange-50', border: 'border-orange-500', text: 'text-orange-700', dot: 'bg-orange-500' },
                p3: { bg: 'bg-green-50', border: 'border-green-500', text: 'text-green-700', dot: 'bg-green-500' }
            };

            const statusColors = {
                ready: 'status-ready',
                'in-progress': 'status-running',
                'not-started': 'bg-gray-100 text-gray-700 border border-gray-300'
            };

            const toggleModulePriority = (priority) => {
                if (selectedModulePriorities.includes(priority)) {
                    setSelectedModulePriorities(selectedModulePriorities.filter(p => p !== priority));
                } else {
                    setSelectedModulePriorities([...selectedModulePriorities, priority]);
                }
            };

            const handleRunByPriority = async () => {
                if (selectedModulePriorities.length === 0) {
                    alert('Please select at least one priority');
                    return;
                }

                const tags = selectedModulePriorities.map(p => `@${p.toUpperCase()}`).join(' or ');
                
                try {
                    const response = await fetch(`${API_BASE}/tests/run`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            modules: [module.id],
                            headless: true,
                            tags: tags
                        })
                    });

                    const data = await response.json();
                    
                    // Switch to execution tab
                    if (data.executionId) {
                        window.dispatchEvent(new CustomEvent('startExecution', { detail: data.executionId }));
                    }
                    
                    alert(`Started ${selectedModulePriorities.map(p => p.toUpperCase()).join(', ')} tests for ${module.name}`);
                    setShowPrioritySelector(false);
                    setSelectedModulePriorities([]);
                } catch (error) {
                    console.error('Error starting tests:', error);
                    alert('Failed to start test execution');
                }
            };

            return (
                <div className="bg-white rounded-xl shadow-md p-6 card-hover border-l-4 border-blue-700">
                    <div className="flex justify-between items-start mb-4">
                        <div className="flex-1">
                            <h3 className="text-xl font-bold text-gray-800 mb-2">{module.name}</h3>
                            <p className="text-gray-600 text-sm">{module.description}</p>
                        </div>
                        <span className={`status-badge ${statusColors[module.status]}`}>
                            {module.status}
                        </span>
                    </div>

                    <div className="grid grid-cols-2 gap-4 mb-4">
                        <div className="bg-gray-50 rounded-lg p-3 border border-gray-200">
                            <div className="text-gray-500 text-xs mb-1 font-semibold">TEST SCENARIOS</div>
                            <div className="text-2xl font-bold text-gray-800">{module.scenarioCount}</div>
                            {module.estimatedTime && (
                                <div className="text-xs text-gray-600 mt-1">‚è± ~{module.estimatedTime}</div>
                            )}
                        </div>
                        <div className="bg-blue-50 rounded-lg p-3 border border-blue-200">
                            <div className="text-blue-700 text-xs mb-1 font-semibold">JIRA STORIES</div>
                            <div className="text-2xl font-bold text-blue-700">
                                <a href={`https://vulcanmaterials.atlassian.net/issues/?filter=16283`} 
                                   target="_blank" 
                                   rel="noopener noreferrer"
                                   className="hover:underline">
                                    {module.jiraStoryCount}
                                </a>
                            </div>
                        </div>
                    </div>

                    {/* Priority Breakdown - Clickable */}
                    <div className="flex flex-wrap gap-2 mb-4">
                        {Object.entries(module.priorityCounts).map(([priority, count]) => {
                            const colors = priorityColors[priority];
                            const isSelected = selectedModulePriorities.includes(priority);
                            return count > 0 ? (
                                <button
                                    key={priority}
                                    onClick={() => {
                                        setShowPrioritySelector(true);
                                        toggleModulePriority(priority);
                                    }}
                                    className={`flex items-center space-x-2 px-3 py-1 rounded-lg border transition-all ${
                                        isSelected 
                                            ? `${colors.bg} ${colors.border} ring-2 ring-offset-1 ring-blue-400` 
                                            : `${colors.bg} ${colors.border} hover:shadow-md`
                                    }`}>
                                    <div className={`w-2 h-2 rounded-full ${colors.dot}`}></div>
                                    <span className={`text-sm font-semibold ${colors.text}`}>
                                        {priority.toUpperCase()}: {count}
                                    </span>
                                    {isSelected && <span className="text-green-600 text-sm">‚úì</span>}
                                </button>
                            ) : null;
                        })}
                    </div>

                    {/* Priority Selection Panel */}
                    {showPrioritySelector && (
                        <div className="bg-blue-50 border-2 border-blue-300 rounded-lg p-4 mb-4">
                            <div className="flex items-center justify-between mb-3">
                                <span className="text-sm font-semibold text-gray-700">
                                    ‚ö° Run by Priority: {selectedModulePriorities.map(p => p.toUpperCase()).join(', ') || 'Select priorities above'}
                                </span>
                                <button
                                    onClick={() => {
                                        setShowPrioritySelector(false);
                                        setSelectedModulePriorities([]);
                                    }}
                                    className="text-gray-500 hover:text-gray-700 text-xl"
                                >
                                    √ó
                                </button>
                            </div>
                            <div className="flex space-x-2">
                                <button
                                    onClick={handleRunByPriority}
                                    disabled={selectedModulePriorities.length === 0}
                                    className="flex-1 vulcan-button py-2 px-4 rounded-lg font-semibold text-sm flex items-center justify-center space-x-2"
                                >
                                    <span>‚ñ∂</span>
                                    <span>Run Selected Priorities</span>
                                </button>
                                <button
                                    onClick={() => {
                                        setShowPrioritySelector(false);
                                        setSelectedModulePriorities([]);
                                    }}
                                    className="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-semibold text-sm"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    )}

                    <div className="flex space-x-2">
                        <button 
                            onClick={() => onRunTests(module)}
                            className="flex-1 vulcan-blue-bg hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors flex items-center justify-center space-x-2">
                            <span>‚ñ∂</span>
                            <span>RUN ALL</span>
                        </button>
                        <button 
                            onClick={() => onViewScenarios(module)}
                            className="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors flex items-center justify-center space-x-2">
                            <span>‚äô</span>
                            <span>VIEW SCENARIOS</span>
                        </button>
                    </div>
                </div>
            );
        }

        // ============ SCENARIO MODAL COMPONENT ============
        function ScenarioModal({ module, onClose, onRun }) {
            const [selectedPriority, setSelectedPriority] = useState('ALL');
            const [selectedScenarios, setSelectedScenarios] = useState(new Set());

            const filteredScenarios = selectedPriority === 'ALL' 
                ? module.scenarios 
                : module.scenarios.filter(s => s.priority === selectedPriority);

            const priorityCounts = {
                ALL: module.scenarios.length,
                P1: module.priorityCounts.p1,
                P2: module.priorityCounts.p2,
                P3: module.priorityCounts.p3
            };

            const toggleScenario = (scenarioName) => {
                const newSelected = new Set(selectedScenarios);
                if (newSelected.has(scenarioName)) {
                    newSelected.delete(scenarioName);
                } else {
                    newSelected.add(scenarioName);
                }
                setSelectedScenarios(newSelected);
            };

            const selectAll = () => {
                setSelectedScenarios(new Set(filteredScenarios.map(s => s.name)));
            };

            const deselectAll = () => {
                setSelectedScenarios(new Set());
            };

            const handleRun = () => {
                onRun(module.id, Array.from(selectedScenarios));
                onClose();
            };

            const priorityColors = {
                ALL: 'bg-gray-100 border-gray-500 text-gray-700',
                P1: 'bg-red-50 border-red-500 text-red-700',
                P2: 'bg-orange-50 border-orange-500 text-orange-700',
                P3: 'bg-green-50 border-green-500 text-green-700'
            };

            return (
                <div className="fixed inset-0 bg-black/50 modal-backdrop flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden shadow-2xl">
                        {/* Header */}
                        <div className="vulcan-gradient text-white p-6">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h2 className="text-2xl font-bold">{module.name}</h2>
                                    <p className="text-gray-300 mt-1">Select scenarios to execute</p>
                                </div>
                                <button onClick={onClose} 
                                        className="text-white hover:bg-white/20 rounded-lg p-2 transition-colors">
                                    <span className="text-2xl">√ó</span>
                                </button>
                            </div>
                        </div>

                        {/* Priority Filter */}
                        <div className="p-6 border-b border-gray-200 bg-gray-50">
                            <div className="flex space-x-2">
                                {['ALL', 'P1', 'P2', 'P3'].map(priority => (
                                    <button
                                        key={priority}
                                        onClick={() => setSelectedPriority(priority)}
                                        className={`px-4 py-2 rounded-lg border-2 font-semibold transition-all ${
                                            selectedPriority === priority 
                                                ? priorityColors[priority] 
                                                : 'bg-white border-gray-300 text-gray-600 hover:border-blue-400'
                                        }`}>
                                        {priority} ({priorityCounts[priority]})
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Scenarios List */}
                        <div className="p-6 overflow-y-auto" style={{maxHeight: '400px'}}>
                            <div className="flex justify-between mb-4">
                                <button onClick={selectAll} 
                                        className="vulcan-blue hover:text-blue-800 font-semibold text-sm">
                                    SELECT ALL ({filteredScenarios.length})
                                </button>
                                <button onClick={deselectAll} 
                                        className="text-gray-600 hover:text-gray-700 font-semibold text-sm">
                                    DESELECT ALL
                                </button>
                            </div>

                            <div className="space-y-3">
                                {filteredScenarios.map((scenario, idx) => {
                                    const isSelected = selectedScenarios.has(scenario.name);
                                    const colors = {
                                        P1: 'border-red-200 bg-red-50',
                                        P2: 'border-orange-200 bg-orange-50',
                                        P3: 'border-green-200 bg-green-50'
                                    };

                                    return (
                                        <div key={idx} 
                                             className={`border-2 rounded-lg p-4 cursor-pointer transition-all ${
                                                 isSelected 
                                                     ? 'border-blue-500 bg-blue-50' 
                                                     : colors[scenario.priority] + ' hover:border-blue-300'
                                             }`}
                                             onClick={() => toggleScenario(scenario.name)}>
                                            <div className="flex items-start space-x-3">
                                                <input 
                                                    type="checkbox" 
                                                    checked={isSelected}
                                                    onChange={() => toggleScenario(scenario.name)}
                                                    className="mt-1 w-5 h-5 text-blue-600 rounded"
                                                />
                                                <div className="flex-1">
                                                    <div className="flex items-center space-x-2 mb-1">
                                                        <span className="font-semibold text-gray-800">{scenario.name}</span>
                                                        <span className={`px-2 py-0.5 rounded text-xs font-bold ${
                                                            scenario.priority === 'P1' ? 'bg-red-100 text-red-700' :
                                                            scenario.priority === 'P2' ? 'bg-orange-100 text-orange-700' :
                                                            'bg-green-100 text-green-700'
                                                        }`}>
                                                            {scenario.priority}
                                                        </span>
                                                    </div>
                                                    {scenario.description && (
                                                        <p className="text-gray-600 text-sm">{scenario.description}</p>
                                                    )}
                                                    <div className="flex flex-wrap gap-1 mt-2">
                                                        {scenario.tags.map((tag, i) => (
                                                            <span key={i} className="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded">
                                                                {tag}
                                                            </span>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                        {/* Footer */}
                        <div className="p-6 border-t border-gray-200 bg-gray-50">
                            <div className="flex justify-between items-center">
                                <div className="text-gray-600">
                                    <span className="font-semibold">{selectedScenarios.size}</span> scenarios selected
                                </div>
                                <div className="flex space-x-3">
                                    <button onClick={onClose} 
                                            className="px-6 py-2 border-2 border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-100 transition-colors">
                                        CANCEL
                                    </button>
                                    <button onClick={handleRun}
                                            disabled={selectedScenarios.size === 0}
                                            className={`px-6 py-2 font-semibold rounded-lg transition-colors ${
                                                selectedScenarios.size > 0 
                                                    ? 'vulcan-blue-bg hover:bg-blue-700 text-white' 
                                                    : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                            }`}>
                                        RUN {selectedScenarios.size} TEST{selectedScenarios.size !== 1 ? 'S' : ''}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // ============ EXECUTION TAB COMPONENT ============
        function ExecutionTab({ executionId }) {
            if (!executionId) {
                return (
                    <div className="max-w-7xl mx-auto px-6 py-8">
                        <div className="bg-white rounded-xl shadow-md p-12 text-center">
                            {/* Header with disabled STOP button */}
                            <div className="flex justify-end mb-6">
                                <button 
                                    disabled={true}
                                    className="px-4 py-2 rounded-lg font-semibold bg-gray-400 cursor-not-allowed opacity-50">
                                    STOP
                                </button>
                            </div>
                            <div className="text-6xl mb-4">‚ñ∂</div>
                            <h2 className="text-2xl font-bold text-gray-800 mb-2">No Active Execution</h2>
                            <p className="text-gray-600 mb-6">Select a module from the Modules tab to start test execution</p>
                            <button className="vulcan-button px-6 py-3 rounded-lg font-semibold">
                                Go to Modules
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="h-full">
                    <ExecutionPanel executionId={executionId} onClose={null} fullScreen={true} />
                </div>
            );
        }

        // ============ ANALYTICS TAB COMPONENT ============
        function AnalyticsTab() {
            const [history, setHistory] = useState([]);
            const [loading, setLoading] = useState(true);
            const [filter, setFilter] = useState({ status: 'all', module: 'all' });
            const [selectedExecution, setSelectedExecution] = useState(null);

            useEffect(() => {
                loadHistory();
                
                // Listen for execution completion to refresh data
                const handleExecutionComplete = () => {
                    console.log('Execution completed - refreshing analytics...');
                    loadHistory();
                };
                window.addEventListener('executionComplete', handleExecutionComplete);
                
                return () => {
                    window.removeEventListener('executionComplete', handleExecutionComplete);
                };
            }, []);

            const loadHistory = async () => {
                try {
                    const response = await fetch(`${API_BASE}/tests/history`);
                    const data = await response.json();
                    setHistory(data.history || []);
                } catch (error) {
                    console.error('Error loading history:', error);
                } finally {
                    setLoading(false);
                }
            };

            const filteredHistory = history.filter(exec => {
                if (filter.status !== 'all' && exec.status !== filter.status) return false;
                if (filter.module !== 'all' && !exec.modules.includes(filter.module)) return false;
                return true;
            });

            const stats = {
                total: history.length,
                passed: history.filter(e => e.status === 'completed' && e.result?.failed === 0).length,
                failed: history.filter(e => e.status === 'completed' && e.result?.failed > 0).length,
                running: history.filter(e => e.status === 'running').length
            };

            const passRate = stats.total > 0 ? ((stats.passed / stats.total) * 100).toFixed(1) : 0;

            const downloadReport = () => {
                const dataStr = JSON.stringify(history, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `test-analytics-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
            };

            if (loading) {
                return (
                    <div className="flex items-center justify-center h-full">
                        <div className="text-center">
                            <div className="w-16 h-16 border-4 border-blue-700 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                            <p className="text-gray-600 font-semibold">Loading analytics...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="max-w-7xl mx-auto px-6 py-8">
                    {/* Header with Refresh Button */}
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-gray-800">Test Analytics</h2>
                        <button 
                            onClick={loadHistory}
                            className="flex items-center space-x-2 bg-blue-700 hover:bg-blue-800 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                            <span>üîÑ</span>
                            <span>Refresh</span>
                        </button>
                    </div>
                    {/* Stats Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div className="bg-white rounded-xl shadow-md p-6 border-l-4 border-gray-400">
                            <div className="text-gray-500 text-xs mb-2 font-semibold">TOTAL EXECUTIONS</div>
                            <div className="text-3xl font-bold text-gray-800">{stats.total}</div>
                        </div>
                        <div className="bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500">
                            <div className="text-gray-500 text-xs mb-2 font-semibold">PASSED</div>
                            <div className="text-3xl font-bold text-green-600">{stats.passed}</div>
                        </div>
                        <div className="bg-white rounded-xl shadow-md p-6 border-l-4 border-red-500">
                            <div className="text-gray-500 text-xs mb-2 font-semibold">FAILED</div>
                            <div className="text-3xl font-bold text-red-600">{stats.failed}</div>
                        </div>
                        <div className="bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-700">
                            <div className="text-gray-500 text-xs mb-2 font-semibold">PASS RATE</div>
                            <div className="text-3xl font-bold vulcan-blue">{passRate}%</div>
                        </div>
                    </div>

                    {/* Filters and Actions */}
                    <div className="bg-white rounded-xl shadow-md p-6 mb-6">
                        <div className="flex items-center justify-between flex-wrap gap-4">
                            <div className="flex items-center space-x-4">
                                <div>
                                    <label className="text-xs text-gray-500 font-semibold mb-1 block">STATUS</label>
                                    <select 
                                        value={filter.status}
                                        onChange={(e) => setFilter({...filter, status: e.target.value})}
                                        className="border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-700"
                                    >
                                        <option value="all">All Status</option>
                                        <option value="completed">Completed</option>
                                        <option value="running">Running</option>
                                        <option value="failed">Failed</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs text-gray-500 font-semibold mb-1 block">MODULE</label>
                                    <select 
                                        value={filter.module}
                                        onChange={(e) => setFilter({...filter, module: e.target.value})}
                                        className="border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-700"
                                    >
                                        <option value="all">All Modules</option>
                                        {[...new Set(history.flatMap(e => e.modules))].map(mod => (
                                            <option key={mod} value={mod}>{mod}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                            <button 
                                onClick={downloadReport}
                                className="vulcan-button px-6 py-2 rounded-lg font-semibold flex items-center space-x-2"
                            >
                                <span>‚Üì</span>
                                <span>Download Report</span>
                            </button>
                        </div>
                    </div>

                    {/* Execution History Table */}
                    <div className="bg-white rounded-xl shadow-md overflow-hidden">
                        <div className="bg-gradient-to-r from-vulcan-blue to-vulcan-light-blue text-white px-6 py-4">
                            <h2 className="text-xl font-bold">Execution History</h2>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-gray-50 border-b border-gray-200">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">ID</th>
                                        <th className="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Modules</th>
                                        <th className="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th>
                                        <th className="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Duration</th>
                                        <th className="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Results</th>
                                        <th className="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Started</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredHistory.length === 0 ? (
                                        <tr>
                                            <td colSpan="6" className="px-6 py-12 text-center text-gray-500">
                                                No execution history found
                                            </td>
                                        </tr>
                                    ) : (
                                        filteredHistory.map(exec => (
                                            <tr 
                                                key={exec.id}
                                                className="border-b border-gray-100 hover:bg-gray-50 cursor-pointer"
                                                onClick={() => setSelectedExecution(exec)}
                                            >
                                                <td className="px-6 py-4 text-sm text-gray-800 font-mono">{exec.id.slice(0, 8)}</td>
                                                <td className="px-6 py-4 text-sm text-gray-800">
                                                    {exec.modules.join(', ')}
                                                </td>
                                                <td className="px-6 py-4">
                                                    {exec.status === 'completed' && exec.result?.failed === 0 && (
                                                        <span className="status-badge status-passed">PASSED</span>
                                                    )}
                                                    {exec.status === 'completed' && exec.result?.failed > 0 && (
                                                        <span className="status-badge status-failed">FAILED</span>
                                                    )}
                                                    {exec.status === 'running' && (
                                                        <span className="status-badge status-running">RUNNING</span>
                                                    )}
                                                    {exec.status === 'failed' && (
                                                        <span className="status-badge status-failed">ERROR</span>
                                                    )}
                                                </td>
                                                <td className="px-6 py-4 text-sm text-gray-600">
                                                    {exec.duration ? `${Math.round(exec.duration / 1000)}s` : '-'}
                                                </td>
                                                <td className="px-6 py-4 text-sm">
                                                    {exec.result && (
                                                        <span className="text-gray-600">
                                                            <span className="text-green-600 font-semibold">{exec.result.passed}</span>
                                                            {' / '}
                                                            <span className="text-red-600 font-semibold">{exec.result.failed}</span>
                                                            {' / '}
                                                            <span className="text-gray-500">{exec.result.total}</span>
                                                        </span>
                                                    )}
                                                </td>
                                                <td className="px-6 py-4 text-sm text-gray-600">
                                                    {new Date(exec.startTime).toLocaleString()}
                                                </td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* Execution Details Modal */}
                    {selectedExecution && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden">
                                <div className="bg-gradient-to-r from-vulcan-blue to-vulcan-light-blue text-white px-6 py-4 flex justify-between items-center">
                                    <h2 className="text-xl font-bold">Execution Details</h2>
                                    <button 
                                        onClick={() => setSelectedExecution(null)}
                                        className="text-2xl hover:text-gray-200"
                                    >
                                        √ó
                                    </button>
                                </div>
                                <div className="p-6 overflow-y-auto max-h-[calc(90vh-80px)]">
                                    <div className="grid grid-cols-2 gap-4 mb-6">
                                        <div>
                                            <div className="text-xs text-gray-500 font-semibold mb-1">EXECUTION ID</div>
                                            <div className="text-sm font-mono text-gray-800">{selectedExecution.id}</div>
                                        </div>
                                        <div>
                                            <div className="text-xs text-gray-500 font-semibold mb-1">STATUS</div>
                                            <div className="text-sm text-gray-800">{selectedExecution.status}</div>
                                        </div>
                                        <div>
                                            <div className="text-xs text-gray-500 font-semibold mb-1">STARTED</div>
                                            <div className="text-sm text-gray-800">
                                                {new Date(selectedExecution.startTime).toLocaleString()}
                                            </div>
                                        </div>
                                        <div>
                                            <div className="text-xs text-gray-500 font-semibold mb-1">DURATION</div>
                                            <div className="text-sm text-gray-800">
                                                {selectedExecution.duration ? `${Math.round(selectedExecution.duration / 1000)}s` : '-'}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="mb-4">
                                        <div className="text-xs text-gray-500 font-semibold mb-2">MODULES</div>
                                        <div className="flex flex-wrap gap-2">
                                            {selectedExecution.modules.map(mod => (
                                                <span key={mod} className="px-3 py-1 bg-blue-100 text-blue-800 rounded-lg text-sm">
                                                    {mod}
                                                </span>
                                            ))}
                                        </div>
                                    </div>
                                    {selectedExecution.result && (
                                        <div className="border-t pt-4">
                                            <div className="text-xs text-gray-500 font-semibold mb-2">RESULTS</div>
                                            <div className="grid grid-cols-3 gap-4">
                                                <div className="bg-green-50 rounded-lg p-4 text-center">
                                                    <div className="text-2xl font-bold text-green-600">
                                                        {selectedExecution.result.passed}
                                                    </div>
                                                    <div className="text-xs text-gray-600 mt-1">Passed</div>
                                                </div>
                                                <div className="bg-red-50 rounded-lg p-4 text-center">
                                                    <div className="text-2xl font-bold text-red-600">
                                                        {selectedExecution.result.failed}
                                                    </div>
                                                    <div className="text-xs text-gray-600 mt-1">Failed</div>
                                                </div>
                                                <div className="bg-gray-50 rounded-lg p-4 text-center">
                                                    <div className="text-2xl font-bold text-gray-600">
                                                        {selectedExecution.result.total}
                                                    </div>
                                                    <div className="text-xs text-gray-600 mt-1">Total</div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // ============ EXECUTIVE REPORT TAB COMPONENT ============
        function ExecutiveReportTab() {
            const [reportData, setReportData] = useState(null);
            const [moduleStats, setModuleStats] = useState([]);
            const [scenarios, setScenarios] = useState([]);
            const [expandedModules, setExpandedModules] = useState({});
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                loadReportData();
                
                // Listen for execution completion to refresh data
                const handleExecutionComplete = () => {
                    console.log('Execution completed - refreshing executive report...');
                    setLoading(true);
                    loadReportData();
                };
                window.addEventListener('executionComplete', handleExecutionComplete);
                
                return () => {
                    window.removeEventListener('executionComplete', handleExecutionComplete);
                };
            }, []);

            const loadReportData = async () => {
                try {
                    // Fetch test results from the actual cucumber JSON output
                    const [historyRes, resultsRes] = await Promise.all([
                        fetch(`${API_BASE}/tests/history`),
                        fetch(`${API_BASE}/tests/results`)
                    ]);
                    
                    const historyData = await historyRes.json();
                    const resultsData = await resultsRes.json();
                    
                    // Get completed executions
                    const completedExecs = historyData.history?.filter(e => e.status === 'completed' && e.result) || [];
                    const recentExecution = completedExecs[0];
                    
                    // Use the module stats from test_results.json (actual cucumber output)
                    let moduleStatsData = [];
                    let totalScenarios = 0;
                    let totalPassed = 0;
                    let totalFailed = 0;
                    let totalDuration = 0;
                    
                    if (resultsData.success && resultsData.modules) {
                        moduleStatsData = resultsData.modules.map(m => {
                            const duration = m.duration || 0;
                            const durationSecs = duration / 1000000000; // Convert nanoseconds to seconds
                            const mins = Math.floor(durationSecs / 60);
                            const secs = Math.floor(durationSecs % 60);
                            const timeStr = mins > 0 ? `${mins}m ${secs}s` : `${secs}s`;
                            
                            return {
                                id: m.name.toLowerCase().replace(/\s+/g, '-'),
                                name: m.name,
                                total: m.total,
                                passed: m.passed,
                                failed: m.failed,
                                passRate: m.total > 0 ? ((m.passed / m.total) * 100).toFixed(1) : '0.0',
                                time: timeStr,
                                duration: duration,
                                status: m.failed > 0 ? 'failed' : 'passed',
                                scenarios: (m.scenarios || []).map(s => ({
                                    ...s,
                                    durationStr: formatDuration(s.duration || 0)
                                }))
                            };
                        });
                        
                        // Set scenarios from API
                        if (resultsData.scenarios) {
                            setScenarios(resultsData.scenarios.map(s => ({
                                ...s,
                                durationStr: formatDuration(s.duration || 0)
                            })));
                        }
                        
                        // Calculate totals from actual test results
                        totalScenarios = moduleStatsData.reduce((sum, m) => sum + m.total, 0);
                        totalPassed = moduleStatsData.reduce((sum, m) => sum + m.passed, 0);
                        totalFailed = moduleStatsData.reduce((sum, m) => sum + m.failed, 0);
                        totalDuration = moduleStatsData.reduce((sum, m) => sum + m.duration, 0);
                    }
                    
                    setModuleStats(moduleStatsData);
                    
                    // Format total time
                    const totalDurationSecs = totalDuration / 1000000000;
                    const totalMins = Math.floor(totalDurationSecs / 60);
                    const totalSecs = Math.floor(totalDurationSecs % 60);
                    const totalTime = totalMins > 0 ? `${totalMins}m ${totalSecs}s` : `${totalSecs}s`;
                    
                    if (moduleStatsData.length > 0 || recentExecution) {
                        const report = {
                            timestamp: recentExecution 
                                ? new Date(recentExecution.startTime).toLocaleString()
                                : new Date().toLocaleString(),
                            duration: recentExecution?.duration || totalDuration,
                            summary: {
                                total: totalScenarios,
                                passed: totalPassed,
                                failed: totalFailed,
                                passRate: totalScenarios > 0 
                                    ? ((totalPassed / totalScenarios) * 100).toFixed(1)
                                    : '0.0',
                                totalTime
                            },
                            modules: moduleStatsData.map(m => m.name),
                            executionId: recentExecution?.id || 'N/A'
                        };
                        setReportData(report);
                    }
                } catch (error) {
                    console.error('Error loading report data:', error);
                } finally {
                    setLoading(false);
                }
            };
            
            const formatDuration = (nanoseconds) => {
                const totalSecs = Math.floor(nanoseconds / 1000000000);
                const mins = Math.floor(totalSecs / 60);
                const secs = totalSecs % 60;
                if (mins > 0) {
                    return `${mins}m ${secs}s`;
                }
                return `${secs}s`;
            };
            
            const toggleModule = (moduleId) => {
                setExpandedModules(prev => ({
                    ...prev,
                    [moduleId]: !prev[moduleId]
                }));
            };

            const exportToPDF = () => {
                alert('PDF export functionality coming soon!');
            };

            const exportToExcel = () => {
                alert('Excel export functionality coming soon!');
            };

            if (loading) {
                return (
                    <div className="flex items-center justify-center h-full">
                        <div className="text-center">
                            <div className="w-16 h-16 border-4 border-blue-700 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                            <p className="text-gray-600 font-semibold">Loading executive report...</p>
                        </div>
                    </div>
                );
            }

            if (!reportData) {
                return (
                    <div className="max-w-7xl mx-auto px-6 py-8">
                        <div className="flex justify-end mb-4">
                            <button 
                                onClick={loadReportData}
                                className="flex items-center space-x-2 bg-blue-700 hover:bg-blue-800 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                                <span>üîÑ</span>
                                <span>Refresh</span>
                            </button>
                        </div>
                        <div className="bg-white rounded-xl shadow-md p-12 text-center">
                            <div className="text-6xl mb-4">üìã</div>
                            <h2 className="text-2xl font-bold text-gray-800 mb-2">No Report Data Available</h2>
                            <p className="text-gray-600 mb-6">Run tests from the Modules tab to generate an executive report</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-vulcan-blue to-vulcan-light-blue text-white">
                        <div className="max-w-7xl mx-auto px-6 py-12 text-center">
                            <h1 className="text-4xl font-bold mb-2">Vulcan E-Commerce Test Execution Report</h1>
                            <h2 className="text-2xl font-light mb-4">Quality Assurance Dashboard</h2>
                            <p className="text-gray-200">Last Execution: {reportData.timestamp}</p>
                        </div>
                    </div>

                    {/* Export Buttons */}
                    <div className="bg-white border-b border-gray-200">
                        <div className="max-w-7xl mx-auto px-6 py-4 flex justify-end space-x-3">
                            <button 
                                onClick={loadReportData}
                                className="flex items-center space-x-2 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                                <span>üîÑ</span>
                                <span>Refresh</span>
                            </button>
                            <button 
                                onClick={exportToPDF}
                                className="vulcan-button px-6 py-2 rounded-lg font-semibold flex items-center space-x-2"
                            >
                                <span>üìÑ</span>
                                <span>Export PDF</span>
                            </button>
                            <button 
                                onClick={exportToExcel}
                                className="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold flex items-center space-x-2 transition-all"
                            >
                                <span>üìä</span>
                                <span>Export Excel</span>
                            </button>
                        </div>
                    </div>

                    {/* Summary Cards */}
                    <div className="max-w-7xl mx-auto px-6 py-8">
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                            <div className="bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-700">
                                <h3 className="text-gray-500 text-xs font-semibold uppercase tracking-wide mb-2">
                                    Total Scenarios
                                </h3>
                                <div className="text-4xl font-bold vulcan-blue">{reportData.summary.total}</div>
                            </div>
                            <div className="bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500">
                                <h3 className="text-gray-500 text-xs font-semibold uppercase tracking-wide mb-2">
                                    Passed
                                </h3>
                                <div className="text-4xl font-bold text-green-600">{reportData.summary.passed}</div>
                            </div>
                            <div className="bg-white rounded-xl shadow-md p-6 border-l-4 border-red-500">
                                <h3 className="text-gray-500 text-xs font-semibold uppercase tracking-wide mb-2">
                                    Failed
                                </h3>
                                <div className="text-4xl font-bold text-red-600">{reportData.summary.failed}</div>
                            </div>
                            <div className="bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-700">
                                <h3 className="text-gray-500 text-xs font-semibold uppercase tracking-wide mb-2">
                                    Pass Rate
                                </h3>
                                <div className="text-4xl font-bold vulcan-blue">{reportData.summary.passRate}%</div>
                            </div>
                        </div>

                        {/* Executive Summary */}
                        <div className="bg-white rounded-xl shadow-md p-8 mb-8">
                            <h2 className="text-2xl font-bold vulcan-blue mb-4 pb-3 border-b-2 border-blue-700">
                                Executive Summary
                            </h2>
                            <div className="space-y-4 text-gray-700">
                                <p className="leading-relaxed">
                                    <strong>Test Execution Overview:</strong> The Vulcan E-Commerce platform underwent comprehensive automated 
                                    testing across {reportData.modules.length} critical modules. This report provides a detailed analysis of 
                                    {reportData.summary.total} test scenarios executed during the most recent test run.
                                </p>
                                <p className="leading-relaxed">
                                    <strong>Key Findings:</strong> The test suite achieved a pass rate of <strong className="vulcan-blue">
                                    {reportData.summary.passRate}%</strong>, with {reportData.summary.passed} scenarios passing and {reportData.summary.failed} 
                                    scenarios failing. This indicates {reportData.summary.passRate >= 90 ? 'excellent' : reportData.summary.passRate >= 75 ? 'good' : 'needs attention'} 
                                    {' '}quality standards for the current build.
                                </p>
                                <p className="leading-relaxed">
                                    <strong>Test Coverage:</strong> The automated test suite covers end-to-end user journeys including product 
                                    browsing, cart management, checkout flows, payment processing, and account management. All critical business 
                                    functions have been validated against expected behaviors.
                                </p>
                                {reportData.summary.failed > 0 && (
                                    <div className="bg-red-50 border-l-4 border-red-500 p-4 mt-4">
                                        <p className="text-red-800">
                                            <strong>‚ö† Action Required:</strong> {reportData.summary.failed} test scenario(s) failed and require 
                                            immediate attention. Review the detailed results in the Analytics tab for failure analysis.
                                        </p>
                                    </div>
                                )}
                                {reportData.summary.passRate === 100 && (
                                    <div className="bg-green-50 border-l-4 border-green-500 p-4 mt-4">
                                        <p className="text-green-800">
                                            <strong>‚úì All Tests Passed:</strong> Congratulations! All test scenarios passed successfully. 
                                            The build is ready for the next stage of the deployment pipeline.
                                        </p>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Module Summary Table - Matching cucumber-report.html format */}
                        <div className="bg-white rounded-xl shadow-md overflow-hidden">
                            <div className="bg-gradient-to-r from-vulcan-blue to-vulcan-light-blue text-white px-6 py-4">
                                <h2 className="text-xl font-bold">üìä Executive Summary - Module Status</h2>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-vulcan-blue text-white">
                                        <tr>
                                            <th className="px-4 py-3 text-left text-sm font-semibold">Module</th>
                                            <th className="px-4 py-3 text-center text-sm font-semibold">Status</th>
                                            <th className="px-4 py-3 text-center text-sm font-semibold">Total</th>
                                            <th className="px-4 py-3 text-center text-sm font-semibold">Passed</th>
                                            <th className="px-4 py-3 text-center text-sm font-semibold">Failed</th>
                                            <th className="px-4 py-3 text-center text-sm font-semibold">Pass Rate</th>
                                            <th className="px-4 py-3 text-center text-sm font-semibold">Time</th>
                                            <th className="px-4 py-3 text-center text-sm font-semibold">Progress</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {moduleStats.length === 0 ? (
                                            <tr>
                                                <td colSpan="8" className="px-6 py-12 text-center text-gray-500">
                                                    No module data available. Run tests to generate report.
                                                </td>
                                            </tr>
                                        ) : (
                                            moduleStats.map((module, idx) => (
                                                <React.Fragment key={idx}>
                                                    <tr 
                                                        className="border-b border-gray-100 hover:bg-gray-50 cursor-pointer"
                                                        onClick={() => toggleModule(module.id)}
                                                    >
                                                        <td className="px-4 py-4 text-sm text-gray-800 font-medium">
                                                            <span className="mr-2">{expandedModules[module.id] ? 'üìÇ' : 'ÔøΩ'}</span>
                                                            {module.name}
                                                            <span className="ml-2 text-gray-400 text-xs">
                                                                {expandedModules[module.id] ? '‚ñº' : '‚ñ∂'}
                                                            </span>
                                                        </td>
                                                        <td className="px-4 py-4 text-center">
                                                            {module.failed === 0 ? (
                                                                <span className="text-green-600 text-xl">‚úÖ</span>
                                                            ) : (
                                                                <span className="text-red-600 text-xl">‚ùå</span>
                                                            )}
                                                        </td>
                                                        <td className="px-4 py-4 text-center text-sm text-gray-800 font-semibold">
                                                            {module.total}
                                                        </td>
                                                        <td className="px-4 py-4 text-center text-sm text-green-600 font-semibold">
                                                            {module.passed}
                                                        </td>
                                                        <td className="px-4 py-4 text-center text-sm text-red-600 font-semibold">
                                                            {module.failed}
                                                        </td>
                                                        <td className="px-4 py-4 text-center text-sm font-semibold"
                                                            style={{color: parseFloat(module.passRate) >= 90 ? '#16a34a' : parseFloat(module.passRate) >= 70 ? '#ca8a04' : '#dc2626'}}>
                                                            {module.passRate}%
                                                        </td>
                                                        <td className="px-4 py-4 text-center text-sm text-gray-600">
                                                            {module.time}
                                                        </td>
                                                        <td className="px-4 py-4">
                                                            <div className="w-32 h-4 bg-gray-200 rounded-full overflow-hidden">
                                                                <div className="h-full flex">
                                                                    <div 
                                                                        className="bg-green-500 h-full" 
                                                                        style={{width: `${(module.passed / module.total) * 100}%`}}
                                                                    ></div>
                                                                    <div 
                                                                        className="bg-red-500 h-full" 
                                                                        style={{width: `${(module.failed / module.total) * 100}%`}}
                                                                    ></div>
                                                                </div>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    {/* Expanded Scenario Details */}
                                                    {expandedModules[module.id] && module.scenarios && (
                                                        <tr>
                                                            <td colSpan="8" className="px-0 py-0 bg-gray-50">
                                                                <div className="px-8 py-4">
                                                                    <table className="w-full text-sm">
                                                                        <thead>
                                                                            <tr className="bg-gray-100">
                                                                                <th className="px-3 py-2 text-left font-medium text-gray-600">Scenario</th>
                                                                                <th className="px-3 py-2 text-center font-medium text-gray-600 w-20">Status</th>
                                                                                <th className="px-3 py-2 text-center font-medium text-gray-600 w-24">Duration</th>
                                                                                <th className="px-3 py-2 text-left font-medium text-gray-600">Tags</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                            {module.scenarios.map((scenario, sIdx) => (
                                                                                <tr key={sIdx} className="border-b border-gray-200 hover:bg-white">
                                                                                    <td className="px-3 py-2 text-gray-800">
                                                                                        {scenario.status === 'passed' ? (
                                                                                            <span className="mr-2 text-green-500">‚úì</span>
                                                                                        ) : (
                                                                                            <span className="mr-2 text-red-500">‚úó</span>
                                                                                        )}
                                                                                        {scenario.name}
                                                                                    </td>
                                                                                    <td className="px-3 py-2 text-center">
                                                                                        <span className={`px-2 py-1 rounded text-xs font-semibold ${
                                                                                            scenario.status === 'passed' 
                                                                                                ? 'bg-green-100 text-green-800' 
                                                                                                : 'bg-red-100 text-red-800'
                                                                                        }`}>
                                                                                            {scenario.status.toUpperCase()}
                                                                                        </span>
                                                                                    </td>
                                                                                    <td className="px-3 py-2 text-center text-gray-600">
                                                                                        {scenario.durationStr}
                                                                                    </td>
                                                                                    <td className="px-3 py-2">
                                                                                        {(scenario.tags || []).map((tag, tIdx) => (
                                                                                            <span key={tIdx} className="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-0.5 rounded mr-1 mb-1">
                                                                                                {tag}
                                                                                            </span>
                                                                                        ))}
                                                                                    </td>
                                                                                </tr>
                                                                            ))}
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    )}
                                                </React.Fragment>
                                            ))
                                        )}
                                    </tbody>
                                    {/* Total Row */}
                                    {moduleStats.length > 0 && (
                                        <tfoot className="bg-gray-100 font-bold">
                                            <tr className="border-t-2 border-gray-300">
                                                <td className="px-4 py-4 text-sm text-gray-800">
                                                    <span className="mr-2">üìä</span>
                                                    TOTAL
                                                </td>
                                                <td className="px-4 py-4 text-center">
                                                    {reportData.summary.failed > 0 ? (
                                                        <span className="text-red-600 text-xl">‚ùå</span>
                                                    ) : (
                                                        <span className="text-green-600 text-xl">‚úÖ</span>
                                                    )}
                                                </td>
                                                <td className="px-4 py-4 text-center text-sm text-gray-800">
                                                    {reportData.summary.total}
                                                </td>
                                                <td className="px-4 py-4 text-center text-sm text-green-600">
                                                    {reportData.summary.passed}
                                                </td>
                                                <td className="px-4 py-4 text-center text-sm text-red-600">
                                                    {reportData.summary.failed}
                                                </td>
                                                <td className="px-4 py-4 text-center text-sm"
                                                    style={{color: parseFloat(reportData.summary.passRate) >= 90 ? '#16a34a' : parseFloat(reportData.summary.passRate) >= 70 ? '#ca8a04' : '#dc2626'}}>
                                                    {reportData.summary.passRate}%
                                                </td>
                                                <td className="px-4 py-4 text-center text-sm text-gray-600">
                                                    {reportData.summary.totalTime}
                                                </td>
                                                <td className="px-4 py-4">
                                                    <div className="w-32 h-4 bg-gray-200 rounded-full overflow-hidden">
                                                        <div className="h-full flex">
                                                            <div 
                                                                className="bg-green-500 h-full" 
                                                                style={{width: `${(reportData.summary.passed / reportData.summary.total) * 100}%`}}
                                                            ></div>
                                                            <div 
                                                                className="bg-red-500 h-full" 
                                                                style={{width: `${(reportData.summary.failed / reportData.summary.total) * 100}%`}}
                                                            ></div>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tfoot>
                                    )}
                                </table>
                            </div>
                        </div>

                        {/* Execution Details */}
                        <div className="bg-white rounded-xl shadow-md p-8 mt-8">
                            <h2 className="text-2xl font-bold vulcan-blue mb-4 pb-3 border-b-2 border-blue-700">
                                Execution Details
                            </h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h3 className="text-xs font-semibold text-gray-500 uppercase mb-2">Execution ID</h3>
                                    <p className="text-gray-800 font-mono">{reportData.executionId}</p>
                                </div>
                                <div>
                                    <h3 className="text-xs font-semibold text-gray-500 uppercase mb-2">Execution Time</h3>
                                    <p className="text-gray-800">{reportData.timestamp}</p>
                                </div>
                                <div>
                                    <h3 className="text-xs font-semibold text-gray-500 uppercase mb-2">Duration</h3>
                                    <p className="text-gray-800">
                                        {reportData.duration ? `${Math.round(reportData.duration / 1000 / 60)} minutes` : 'N/A'}
                                    </p>
                                </div>
                                <div>
                                    <h3 className="text-xs font-semibold text-gray-500 uppercase mb-2">Environment</h3>
                                    <p className="text-gray-800">QA - https://qa-shop.vulcanmaterials.com</p>
                                </div>
                            </div>
                        </div>

                        {/* Recommendations */}
                        <div className="bg-white rounded-xl shadow-md p-8 mt-8">
                            <h2 className="text-2xl font-bold vulcan-blue mb-4 pb-3 border-b-2 border-blue-700">
                                Recommendations
                            </h2>
                            <ul className="space-y-3 text-gray-700">
                                {reportData.summary.passRate === 100 ? (
                                    <>
                                        <li className="flex items-start">
                                            <span className="text-green-600 mr-2">‚úì</span>
                                            <span>All tests passed. Build is approved for deployment to staging environment.</span>
                                        </li>
                                        <li className="flex items-start">
                                            <span className="text-green-600 mr-2">‚úì</span>
                                            <span>Continue monitoring test stability and execution time trends.</span>
                                        </li>
                                    </>
                                ) : reportData.summary.passRate >= 90 ? (
                                    <>
                                        <li className="flex items-start">
                                            <span className="text-yellow-600 mr-2">‚ö†</span>
                                            <span>Review and fix {reportData.summary.failed} failing test(s) before production deployment.</span>
                                        </li>
                                        <li className="flex items-start">
                                            <span className="text-yellow-600 mr-2">‚ö†</span>
                                            <span>Conditional approval for staging deployment with bug tracking.</span>
                                        </li>
                                    </>
                                ) : (
                                    <>
                                        <li className="flex items-start">
                                            <span className="text-red-600 mr-2">‚úó</span>
                                            <span>Build requires immediate attention. {reportData.summary.failed} critical failures detected.</span>
                                        </li>
                                        <li className="flex items-start">
                                            <span className="text-red-600 mr-2">‚úó</span>
                                            <span>Deployment blocked until pass rate reaches 90% or higher.</span>
                                        </li>
                                        <li className="flex items-start">
                                            <span className="text-red-600 mr-2">‚úó</span>
                                            <span>Recommend root cause analysis meeting with development team.</span>
                                        </li>
                                    </>
                                )}
                                <li className="flex items-start">
                                    <span className="text-blue-600 mr-2">‚Ñπ</span>
                                    <span>For detailed test logs and failure analysis, navigate to the Analytics tab.</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            );
        }

        // ============ AI COMMANDER TAB COMPONENT ============
        function AICommanderTab() {
            const [command, setCommand] = useState('');
            const [history, setHistory] = useState([]);
            const [processing, setProcessing] = useState(false);

            const exampleCommands = [
                'Generate test scenarios for Cart module',
                'Run all P1 tests',
                'Analyze last execution failures',
                'Create regression suite for Checkout',
                'Find flaky tests in Search module'
            ];

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!command.trim()) return;

                const newEntry = {
                    id: Date.now(),
                    command: command,
                    status: 'processing',
                    timestamp: new Date()
                };

                setHistory([newEntry, ...history]);
                setCommand('');
                setProcessing(true);

                // TODO: Implement AI command processing endpoint
                setTimeout(() => {
                    setHistory(prev => prev.map(entry => 
                        entry.id === newEntry.id 
                            ? { ...entry, status: 'completed', response: 'Feature coming soon! AI integration is in progress.' }
                            : entry
                    ));
                    setProcessing(false);
                }, 2000);
            };

            return (
                <div className="max-w-5xl mx-auto px-6 py-8">
                    {/* Header */}
                    <div className="mb-8">
                        <h1 className="text-3xl font-bold text-gray-800 mb-2">AI Commander</h1>
                        <p className="text-gray-600">Use natural language to generate tests, run executions, and analyze results</p>
                    </div>

                    {/* Command Input */}
                    <div className="bg-white rounded-xl shadow-md p-6 mb-6">
                        <form onSubmit={handleSubmit}>
                            <div className="flex space-x-4">
                                <input
                                    type="text"
                                    value={command}
                                    onChange={(e) => setCommand(e.target.value)}
                                    placeholder="Enter your command... (e.g., 'Generate test scenarios for Cart module')"
                                    className="flex-1 border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-700"
                                    disabled={processing}
                                />
                                <button 
                                    type="submit"
                                    className="vulcan-button px-8 py-3 rounded-lg font-semibold flex items-center space-x-2"
                                    disabled={processing || !command.trim()}
                                >
                                    {processing ? (
                                        <>
                                            <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                            <span>Processing...</span>
                                        </>
                                    ) : (
                                        <>
                                            <span>‚Üí</span>
                                            <span>Send</span>
                                        </>
                                    )}
                                </button>
                            </div>
                        </form>

                        {/* Example Commands */}
                        <div className="mt-4">
                            <div className="text-xs text-gray-500 font-semibold mb-2">EXAMPLE COMMANDS</div>
                            <div className="flex flex-wrap gap-2">
                                {exampleCommands.map((example, idx) => (
                                    <button
                                        key={idx}
                                        onClick={() => setCommand(example)}
                                        className="px-3 py-1 bg-gray-100 hover:bg-blue-50 text-gray-700 hover:text-blue-700 rounded-lg text-sm transition-colors"
                                        disabled={processing}
                                    >
                                        {example}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Command History */}
                    <div className="bg-white rounded-xl shadow-md overflow-hidden">
                        <div className="bg-gradient-to-r from-vulcan-blue to-vulcan-light-blue text-white px-6 py-4">
                            <h2 className="text-xl font-bold">Command History</h2>
                        </div>
                        <div className="p-6">
                            {history.length === 0 ? (
                                <div className="text-center py-12 text-gray-500">
                                    <div className="text-5xl mb-4">ü§ñ</div>
                                    <p>No commands yet. Try sending one above!</p>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    {history.map(entry => (
                                        <div key={entry.id} className="border border-gray-200 rounded-lg p-4">
                                            <div className="flex items-start justify-between mb-2">
                                                <div className="flex-1">
                                                    <div className="text-sm font-semibold text-gray-800 mb-1">
                                                        {entry.command}
                                                    </div>
                                                    <div className="text-xs text-gray-500">
                                                        {entry.timestamp.toLocaleString()}
                                                    </div>
                                                </div>
                                                <div>
                                                    {entry.status === 'processing' && (
                                                        <span className="status-badge status-running">PROCESSING</span>
                                                    )}
                                                    {entry.status === 'completed' && (
                                                        <span className="status-badge status-passed">COMPLETED</span>
                                                    )}
                                                    {entry.status === 'error' && (
                                                        <span className="status-badge status-failed">ERROR</span>
                                                    )}
                                                </div>
                                            </div>
                                            {entry.response && (
                                                <div className="mt-3 bg-gray-50 rounded-lg p-3">
                                                    <div className="text-sm text-gray-700">{entry.response}</div>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // ============ AI FEATURE GENERATOR TAB COMPONENT ============
        function AIFeatureGeneratorTab() {
            const [jiraInput, setJiraInput] = useState('');
            const [inputType, setInputType] = useState('story'); // story, epic, filter
            const [loading, setLoading] = useState(false);
            const [generatedScenarios, setGeneratedScenarios] = useState([]);
            const [selectedScenarios, setSelectedScenarios] = useState(new Set()); // Track selected scenarios
            const [acceptanceCriteria, setAcceptanceCriteria] = useState([]);
            const [jiraDetails, setJiraDetails] = useState(null);
            const [matchResults, setMatchResults] = useState(null);
            const [checkingMatches, setCheckingMatches] = useState(false);
            const [selectedModule, setSelectedModule] = useState('');
            const [newFeatureFileName, setNewFeatureFileName] = useState('');
            const [modules, setModules] = useState([]);
            const [saving, setSaving] = useState(false);
            const [saveResult, setSaveResult] = useState(null);
            
            // Step definition states
            const [stepDefResults, setStepDefResults] = useState(null);
            const [checkingStepDefs, setCheckingStepDefs] = useState(false);
            const [generatedStepDefs, setGeneratedStepDefs] = useState(null);
            const [generatingStepDefs, setGeneratingStepDefs] = useState(false);
            const [savingStepDefs, setSavingStepDefs] = useState(false);
            const [stepDefSaveResult, setStepDefSaveResult] = useState(null);
            
            // Smart analysis states
            const [smartAnalysis, setSmartAnalysis] = useState(null);
            const [analyzingScenarios, setAnalyzingScenarios] = useState(false);
            const [useSmartMode, setUseSmartMode] = useState(true); // Default to smart mode

            // Toggle scenario selection
            const toggleScenarioSelection = (idx) => {
                setSelectedScenarios(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(idx)) {
                        newSet.delete(idx);
                    } else {
                        newSet.add(idx);
                    }
                    return newSet;
                });
            };

            // Select/Deselect all scenarios
            const toggleSelectAll = () => {
                if (selectedScenarios.size === generatedScenarios.length) {
                    setSelectedScenarios(new Set());
                } else {
                    setSelectedScenarios(new Set(generatedScenarios.map((_, idx) => idx)));
                }
            };

            // Get only selected scenarios for saving
            const getSelectedScenarios = () => {
                return generatedScenarios.filter((_, idx) => selectedScenarios.has(idx));
            };

            // Get matches for a specific scenario
            const getMatchesForScenario = (scenarioName) => {
                if (!matchResults || !matchResults.matches) return [];
                return matchResults.matches.filter(m => 
                    m.newScenario && m.newScenario.toLowerCase() === scenarioName.toLowerCase()
                );
            };

            // Check if a scenario has matches
            const hasMatchForScenario = (scenarioName) => {
                return getMatchesForScenario(scenarioName).length > 0;
            };

            useEffect(() => {
                loadModules();
            }, []);

            const loadModules = async () => {
                try {
                    const response = await fetch(`${API_BASE}/modules`);
                    const data = await response.json();
                    setModules(data.modules || []);
                } catch (error) {
                    console.error('Error loading modules:', error);
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!jiraInput.trim()) return;

                setLoading(true);
                setGeneratedScenarios([]);
                setAcceptanceCriteria([]);
                setJiraDetails(null);
                setMatchResults(null);
                setSaveResult(null);

                try {
                    const response = await fetch(`${API_BASE}/ai/generate-scenarios`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            jiraInput: jiraInput.trim(),
                            inputType: inputType
                        })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        setJiraDetails(data.jiraDetails);
                        setAcceptanceCriteria(data.acceptanceCriteria || []);
                        setGeneratedScenarios(data.scenarios || []);
                        // Auto-select all scenarios by default
                        setSelectedScenarios(new Set((data.scenarios || []).map((_, idx) => idx)));
                    } else {
                        alert(data.error || 'Failed to generate scenarios');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to connect to server');
                } finally {
                    setLoading(false);
                }
            };

            const handleCheckMatches = async () => {
                if (generatedScenarios.length === 0) return;

                setCheckingMatches(true);
                setMatchResults(null);

                try {
                    const response = await fetch(`${API_BASE}/ai/check-scenario-matches`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            scenarios: generatedScenarios
                        })
                    });

                    const data = await response.json();
                    setMatchResults(data);
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to check matches');
                } finally {
                    setCheckingMatches(false);
                }
            };

            // Smart Analysis - Determines extend vs create new
            const handleSmartAnalysis = async () => {
                if (!selectedModule || generatedScenarios.length === 0) return;

                setAnalyzingScenarios(true);
                setSmartAnalysis(null);

                try {
                    const response = await fetch(`${API_BASE}/ai/smart-scenario-analysis`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            scenarios: generatedScenarios,
                            moduleId: selectedModule
                        })
                    });

                    const data = await response.json();
                    setSmartAnalysis(data);
                } catch (error) {
                    console.error('Error:', error);
                    setSmartAnalysis({ success: false, error: 'Failed to analyze scenarios' });
                } finally {
                    setAnalyzingScenarios(false);
                }
            };

            // Apply smart recommendations
            const handleApplySmartRecommendations = async () => {
                if (!smartAnalysis || !selectedModule) return;

                setSaving(true);
                setSaveResult(null);

                try {
                    const response = await fetch(`${API_BASE}/ai/apply-smart-scenarios`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            moduleId: selectedModule,
                            newScenarios: smartAnalysis.newScenarios,
                            extendExisting: smartAnalysis.extendExisting,
                            jiraKey: jiraInput.trim()
                        })
                    });

                    const data = await response.json();
                    setSaveResult(data);

                    if (data.success) {
                        loadModules();
                    }
                } catch (error) {
                    console.error('Error:', error);
                    setSaveResult({ success: false, error: 'Failed to apply recommendations' });
                } finally {
                    setSaving(false);
                }
            };

            const handleAddToExisting = async () => {
                const scenariosToSave = getSelectedScenarios();
                if (!selectedModule || scenariosToSave.length === 0) {
                    alert('Please select at least one scenario to save');
                    return;
                }

                setSaving(true);
                setSaveResult(null);

                try {
                    const response = await fetch(`${API_BASE}/ai/add-to-feature`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            moduleId: selectedModule,
                            scenarios: scenariosToSave,
                            jiraKey: jiraInput.trim()
                        })
                    });

                    const data = await response.json();
                    setSaveResult(data);
                    
                    if (data.success) {
                        loadModules(); // Refresh modules
                    }
                } catch (error) {
                    console.error('Error:', error);
                    setSaveResult({ success: false, error: 'Failed to save scenarios' });
                } finally {
                    setSaving(false);
                }
            };

            const handleCreateNewFeature = async () => {
                const scenariosToSave = getSelectedScenarios();
                if (!newFeatureFileName.trim() || scenariosToSave.length === 0) {
                    alert('Please select at least one scenario to save');
                    return;
                }

                setSaving(true);
                setSaveResult(null);

                try {
                    const response = await fetch(`${API_BASE}/ai/create-feature`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            fileName: newFeatureFileName.trim(),
                            scenarios: scenariosToSave,
                            jiraKey: jiraInput.trim(),
                            featureTitle: jiraDetails?.summary || 'New Feature'
                        })
                    });

                    const data = await response.json();
                    setSaveResult(data);
                    
                    if (data.success) {
                        loadModules(); // Refresh modules
                    }
                } catch (error) {
                    console.error('Error:', error);
                    setSaveResult({ success: false, error: 'Failed to create feature file' });
                } finally {
                    setSaving(false);
                }
            };

            // Check which steps have existing definitions
            const handleCheckStepDefinitions = async () => {
                const scenariosToCheck = getSelectedScenarios();
                if (!scenariosToCheck || scenariosToCheck.length === 0) {
                    alert('Please select at least one scenario to check step definitions');
                    return;
                }
                
                setCheckingStepDefs(true);
                try {
                    const response = await fetch('/api/ai/check-step-definitions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ scenarios: scenariosToCheck })
                    });
                    const data = await response.json();
                    setStepDefResults(data);
                } catch (error) {
                    console.error('Error checking step definitions:', error);
                    setStepDefResults({ success: false, error: 'Failed to check step definitions' });
                } finally {
                    setCheckingStepDefs(false);
                }
            };

            // Generate code for missing step definitions
            const handleGenerateStepDefinitions = async () => {
                if (!stepDefResults || !stepDefResults.missingSteps || stepDefResults.missingSteps.length === 0) return;
                
                setGeneratingStepDefs(true);
                try {
                    const scenariosToCheck = getSelectedScenarios();
                    const moduleName = selectedModule || (scenariosToCheck[0]?.module) || 'common';
                    const response = await fetch('/api/ai/generate-step-definitions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            missingSteps: stepDefResults.missingSteps,
                            moduleName: moduleName
                        })
                    });
                    const data = await response.json();
                    setGeneratedStepDefs(data);
                } catch (error) {
                    console.error('Error generating step definitions:', error);
                    setGeneratedStepDefs({ success: false, error: 'Failed to generate step definitions' });
                } finally {
                    setGeneratingStepDefs(false);
                }
            };

            return (
                <div className="flex h-full">
                    {/* Left Panel - Input & Jira Details */}
                    <div className="w-1/2 p-6 overflow-y-auto border-r border-gray-200">
                        <div className="mb-6">
                            <h1 className="text-2xl font-bold text-gray-800 mb-2">‚ú® AI Feature Generator</h1>
                            <p className="text-gray-600 text-sm">Generate test scenarios from Jira stories, epics, or filters</p>
                        </div>

                        {/* Input Form */}
                        <div className="bg-white rounded-xl shadow-md p-6 mb-6">
                            <form onSubmit={handleSubmit}>
                                <div className="mb-4">
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Input Type</label>
                                    <div className="flex space-x-4">
                                        {['story', 'epic', 'filter'].map(type => (
                                            <label key={type} className="flex items-center">
                                                <input
                                                    type="radio"
                                                    name="inputType"
                                                    value={type}
                                                    checked={inputType === type}
                                                    onChange={(e) => setInputType(e.target.value)}
                                                    className="mr-2"
                                                />
                                                <span className="capitalize">{type === 'filter' ? 'Jira Filter' : `Jira ${type}`}</span>
                                            </label>
                                        ))}
                                    </div>
                                </div>

                                <div className="mb-4">
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                                        {inputType === 'filter' ? 'Filter ID or JQL' : `${inputType.charAt(0).toUpperCase() + inputType.slice(1)} Key`}
                                    </label>
                                    <input
                                        type="text"
                                        value={jiraInput}
                                        onChange={(e) => setJiraInput(e.target.value)}
                                        placeholder={inputType === 'filter' ? 'e.g., 12345 or project = ECOMM' : `e.g., ECOMM-${inputType === 'epic' ? '100' : '1234'}`}
                                        className="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-700"
                                        disabled={loading}
                                    />
                                </div>

                                <button 
                                    type="submit"
                                    className="w-full vulcan-button px-6 py-3 rounded-lg font-semibold flex items-center justify-center space-x-2"
                                    disabled={loading || !jiraInput.trim()}
                                >
                                    {loading ? (
                                        <>
                                            <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                            <span>Analyzing Jira & Generating Scenarios...</span>
                                        </>
                                    ) : (
                                        <>
                                            <span>üîç</span>
                                            <span>Generate Test Scenarios</span>
                                        </>
                                    )}
                                </button>
                            </form>
                        </div>

                        {/* Jira Details */}
                        {jiraDetails && (
                            <div className="bg-white rounded-xl shadow-md p-6 mb-6">
                                <h3 className="text-lg font-bold text-gray-800 mb-4">üìã Jira Details</h3>
                                <div className="space-y-3">
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <span className="text-xs text-gray-500 uppercase">Key</span>
                                            <p className="font-semibold text-blue-700">{jiraDetails.key}</p>
                                        </div>
                                        {jiraDetails.type && (
                                            <span className={`px-3 py-1 rounded-full text-xs font-semibold ${
                                                jiraDetails.type === 'Epic' 
                                                    ? 'bg-purple-100 text-purple-700' 
                                                    : 'bg-blue-100 text-blue-700'
                                            }`}>
                                                {jiraDetails.type}
                                            </span>
                                        )}
                                    </div>
                                    <div>
                                        <span className="text-xs text-gray-500 uppercase">Summary</span>
                                        <p className="text-gray-800">{jiraDetails.summary}</p>
                                    </div>
                                    {jiraDetails.status && (
                                        <div>
                                            <span className="text-xs text-gray-500 uppercase">Status</span>
                                            <p className="text-gray-700">{jiraDetails.status}</p>
                                        </div>
                                    )}
                                    
                                    {/* Child Stories for Epic */}
                                    {jiraDetails.childStories && jiraDetails.childStories.length > 0 && (
                                        <div className="mt-4 pt-4 border-t border-gray-200">
                                            <div className="flex items-center justify-between mb-2">
                                                <span className="text-xs text-gray-500 uppercase">Child Stories</span>
                                                <span className="px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full text-xs font-semibold">
                                                    {jiraDetails.childStories.length} stories
                                                </span>
                                            </div>
                                            <div className="space-y-2 max-h-40 overflow-y-auto">
                                                {jiraDetails.childStories.map((child, idx) => (
                                                    <div key={idx} className="flex items-center p-2 bg-gray-50 rounded-lg text-sm">
                                                        <span className="font-mono text-purple-600 font-semibold mr-2">{child.key}</span>
                                                        <span className="text-gray-700 truncate flex-1">{child.summary}</span>
                                                        <span className={`ml-2 px-2 py-0.5 rounded text-xs ${
                                                            child.status === 'Done' ? 'bg-green-100 text-green-700' :
                                                            child.status === 'In Progress' ? 'bg-blue-100 text-blue-700' :
                                                            'bg-gray-100 text-gray-600'
                                                        }`}>
                                                            {child.status}
                                                        </span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Acceptance Criteria */}
                        {acceptanceCriteria.length > 0 && (
                            <div className="bg-white rounded-xl shadow-md p-6">
                                <h3 className="text-lg font-bold text-gray-800 mb-4">‚úÖ Acceptance Criteria</h3>
                                <ul className="space-y-2">
                                    {acceptanceCriteria.map((ac, idx) => (
                                        <li key={idx} className="flex items-start">
                                            <span className="text-green-500 mr-2">‚Ä¢</span>
                                            <span className="text-gray-700 text-sm">{ac}</span>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        )}
                    </div>

                    {/* Right Panel - Generated Scenarios & Actions */}
                    <div className="w-1/2 p-6 overflow-y-auto bg-gray-50">
                        <div className="mb-6">
                            <h2 className="text-xl font-bold text-gray-800 mb-2">Generated Test Scenarios</h2>
                            <p className="text-gray-600 text-sm">Review and save scenarios to feature files</p>
                        </div>

                        {/* Scenarios List */}
                        {generatedScenarios.length > 0 ? (
                            <>
                                <div className="bg-white rounded-xl shadow-md p-6 mb-6">
                                    <div className="flex items-center justify-between mb-4">
                                        <span className="text-sm font-semibold text-gray-700">
                                            {generatedScenarios.length} Scenario{generatedScenarios.length !== 1 ? 's' : ''} Generated
                                        </span>
                                        <button
                                            onClick={handleCheckMatches}
                                            className="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm font-semibold hover:bg-blue-200 transition-colors flex items-center space-x-2"
                                            disabled={checkingMatches}
                                        >
                                            {checkingMatches ? (
                                                <>
                                                    <div className="w-4 h-4 border-2 border-blue-700 border-t-transparent rounded-full animate-spin"></div>
                                                    <span>Checking...</span>
                                                </>
                                            ) : (
                                                <>
                                                    <span>üîé</span>
                                                    <span>Check if Scenarios Exist</span>
                                                </>
                                            )}
                                        </button>
                                    </div>

                                    {/* Select All / Count Header */}
                                    <div className="flex items-center justify-between mb-3 px-1">
                                        <label className="flex items-center cursor-pointer">
                                            <input
                                                type="checkbox"
                                                checked={selectedScenarios.size === generatedScenarios.length && generatedScenarios.length > 0}
                                                onChange={toggleSelectAll}
                                                className="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500 mr-2"
                                            />
                                            <span className="text-sm font-medium text-gray-700">Select All</span>
                                        </label>
                                        <span className="text-sm text-gray-500">
                                            {selectedScenarios.size} of {generatedScenarios.length} selected
                                        </span>
                                    </div>

                                    <div className="space-y-3 max-h-96 overflow-y-auto">
                                        {generatedScenarios.map((scenario, idx) => {
                                            const scenarioMatches = getMatchesForScenario(scenario.name);
                                            const hasMatch = scenarioMatches.length > 0;
                                            
                                            return (
                                            <div 
                                                key={idx} 
                                                className={`border rounded-lg p-3 cursor-pointer transition-all ${
                                                    hasMatch 
                                                        ? 'border-yellow-400 bg-yellow-50' 
                                                        : selectedScenarios.has(idx) 
                                                            ? 'border-blue-400 bg-blue-50 ring-1 ring-blue-200' 
                                                            : 'border-gray-200 bg-gray-50 hover:bg-gray-100'
                                                }`}
                                                onClick={() => toggleScenarioSelection(idx)}
                                            >
                                                <div className="flex items-start">
                                                    <input
                                                        type="checkbox"
                                                        checked={selectedScenarios.has(idx)}
                                                        onChange={() => toggleScenarioSelection(idx)}
                                                        onClick={(e) => e.stopPropagation()}
                                                        className="w-4 h-4 mt-1 text-blue-600 rounded border-gray-300 focus:ring-blue-500 mr-3"
                                                    />
                                                    <span className="text-blue-600 font-mono text-sm mr-2">{idx + 1}.</span>
                                                    <div className="flex-1">
                                                        <div className="flex items-center justify-between">
                                                            <p className="text-sm font-medium text-gray-800">{scenario.name}</p>
                                                            {/* Match Status Badge */}
                                                            {matchResults && (
                                                                hasMatch ? (
                                                                    <span className="px-2 py-0.5 bg-yellow-200 text-yellow-800 rounded-full text-xs font-semibold flex items-center">
                                                                        ‚ö†Ô∏è Similar Exists
                                                                    </span>
                                                                ) : (
                                                                    <span className="px-2 py-0.5 bg-green-200 text-green-800 rounded-full text-xs font-semibold flex items-center">
                                                                        ‚úì New
                                                                    </span>
                                                                )
                                                            )}
                                                        </div>
                                                        
                                                        {/* Show matching existing scenarios */}
                                                        {hasMatch && (
                                                            <div className="mt-2 p-2 bg-yellow-100 border border-yellow-300 rounded text-xs">
                                                                <div className="font-semibold text-yellow-800 mb-1">üîó Similar to existing scenario(s):</div>
                                                                {scenarioMatches.map((match, midx) => (
                                                                    <div key={midx} className="flex items-center text-yellow-700 mt-1">
                                                                        <span className="mr-2">‚Üí</span>
                                                                        <span className="font-medium">{match.featureFile}:</span>
                                                                        <span className="ml-1 italic truncate">{match.scenarioName}</span>
                                                                        <span className="ml-2 px-1 py-0.5 bg-yellow-300 rounded text-yellow-900 font-semibold">
                                                                            {match.matchRatio}% match
                                                                        </span>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                        
                                                        {/* Show source stories for Epic-consolidated scenarios */}
                                                        {scenario.sourceStories && scenario.sourceStories.length > 0 && (
                                                            <div className="mt-2 p-2 bg-purple-50 border border-purple-200 rounded text-xs">
                                                                <div className="font-semibold text-purple-700 mb-1">üì¶ Consolidated from:</div>
                                                                <div className="flex flex-wrap gap-1">
                                                                    {scenario.sourceStories.map((source, sidx) => (
                                                                        <span key={sidx} className="px-2 py-0.5 bg-purple-100 text-purple-700 rounded" title={source.summary}>
                                                                            {source.key}
                                                                        </span>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        )}
                                                        
                                                        {scenario.tags && (
                                                            <div className="flex flex-wrap gap-1 mt-1">
                                                                {scenario.tags.map((tag, tidx) => (
                                                                    <span key={tidx} className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs">
                                                                        {tag}
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        )}
                                                        {/* Show steps preview */}
                                                        {scenario.steps && scenario.steps.length > 0 && (
                                                            <div className="mt-2 text-xs text-gray-500 font-mono bg-white rounded p-2 border border-gray-100">
                                                                {scenario.steps.slice(0, 3).map((step, sidx) => (
                                                                    <div key={sidx} className="truncate">
                                                                        <span className={`font-semibold ${
                                                                            step.keyword === 'Given' ? 'text-purple-600' :
                                                                            step.keyword === 'When' ? 'text-blue-600' :
                                                                            step.keyword === 'Then' ? 'text-green-600' :
                                                                            'text-gray-600'
                                                                        }`}>{step.keyword}</span> {step.text}
                                                                    </div>
                                                                ))}
                                                                {scenario.steps.length > 3 && (
                                                                    <div className="text-gray-400 italic">...and {scenario.steps.length - 3} more steps</div>
                                                                )}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        )})}
                                    </div>

                                    {/* Warning if no scenarios selected */}
                                    {selectedScenarios.size === 0 && (
                                        <div className="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800 text-sm">
                                            ‚ö†Ô∏è No scenarios selected. Please select at least one scenario to save.
                                        </div>
                                    )}
                                </div>

                                {/* Match Results Summary */}
                                {matchResults && (
                                    <div className={`rounded-xl shadow-md p-6 mb-6 ${matchResults.hasMatches ? 'bg-yellow-50 border border-yellow-200' : 'bg-green-50 border border-green-200'}`}>
                                        <h3 className="text-lg font-bold mb-3 flex items-center justify-between">
                                            <div className="flex items-center">
                                                {matchResults.hasMatches ? (
                                                    <>
                                                        <span className="text-yellow-600 mr-2">‚ö†Ô∏è</span>
                                                        <span className="text-yellow-800">Similarity Check Complete</span>
                                                    </>
                                                ) : (
                                                    <>
                                                        <span className="text-green-600 mr-2">‚úÖ</span>
                                                        <span className="text-green-800">All Scenarios are New</span>
                                                    </>
                                                )}
                                            </div>
                                        </h3>
                                        
                                        {matchResults.hasMatches && matchResults.matches ? (
                                            <div>
                                                {/* Summary Stats */}
                                                <div className="flex items-center gap-4 mb-4">
                                                    <div className="flex items-center px-3 py-2 bg-green-100 rounded-lg">
                                                        <span className="text-green-600 font-bold text-lg mr-2">
                                                            {generatedScenarios.length - [...new Set(matchResults.matches.map(m => m.newScenario))].length}
                                                        </span>
                                                        <span className="text-green-700 text-sm">New Scenarios</span>
                                                    </div>
                                                    <div className="flex items-center px-3 py-2 bg-yellow-100 rounded-lg">
                                                        <span className="text-yellow-600 font-bold text-lg mr-2">
                                                            {[...new Set(matchResults.matches.map(m => m.newScenario))].length}
                                                        </span>
                                                        <span className="text-yellow-700 text-sm">Similar to Existing</span>
                                                    </div>
                                                </div>
                                                
                                                <p className="text-sm text-yellow-700 mb-3">
                                                    üí° <strong>Tip:</strong> Scenarios with similar matches are highlighted in yellow above. 
                                                    You may want to uncheck them to avoid duplicates, or keep them if they have different steps.
                                                </p>
                                            </div>
                                        ) : (
                                            <p className="text-sm text-green-700">
                                                ‚ú® Great! All generated scenarios appear to be new and don't have similar existing test cases.
                                            </p>
                                        )}
                                    </div>
                                )}

                                {/* Save Options */}
                                <div className="bg-white rounded-xl shadow-md p-6">
                                    <h3 className="text-lg font-bold text-gray-800 mb-4">üíæ Save Scenarios</h3>
                                    
                                    {/* Smart Mode Toggle */}
                                    <div className="mb-4 p-3 bg-indigo-50 rounded-lg border border-indigo-200">
                                        <label className="flex items-center cursor-pointer">
                                            <input
                                                type="checkbox"
                                                checked={useSmartMode}
                                                onChange={(e) => setUseSmartMode(e.target.checked)}
                                                className="mr-3 w-5 h-5 text-indigo-600"
                                            />
                                            <div>
                                                <span className="font-semibold text-indigo-800">üß† Smart Mode</span>
                                                <p className="text-xs text-indigo-600">Intelligently extend existing scenarios instead of always creating new ones</p>
                                            </div>
                                        </label>
                                    </div>
                                    
                                    {/* Module Selection */}
                                    <div className="mb-4">
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                            Select Target Module
                                        </label>
                                        <select
                                            value={selectedModule}
                                            onChange={(e) => {
                                                setSelectedModule(e.target.value);
                                                setSmartAnalysis(null); // Reset analysis when module changes
                                            }}
                                            className="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-700"
                                        >
                                            <option value="">Select a module...</option>
                                            {modules.map(m => (
                                                <option key={m.id} value={m.id}>{m.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    
                                    {/* Smart Analysis Section */}
                                    {useSmartMode && selectedModule && (
                                        <div className="mb-4">
                                            <button
                                                onClick={handleSmartAnalysis}
                                                disabled={analyzingScenarios}
                                                className="w-full bg-indigo-600 text-white px-4 py-3 rounded-lg hover:bg-indigo-700 transition-all font-semibold flex items-center justify-center space-x-2"
                                            >
                                                {analyzingScenarios ? (
                                                    <>
                                                        <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                                        <span>Analyzing existing scenarios...</span>
                                                    </>
                                                ) : (
                                                    <>
                                                        <span>üîç</span>
                                                        <span>Analyze & Recommend Best Approach</span>
                                                    </>
                                                )}
                                            </button>
                                            
                                            {/* Smart Analysis Results */}
                                            {smartAnalysis && smartAnalysis.success && (
                                                <div className="mt-4 space-y-3">
                                                    {/* Recommendations Summary */}
                                                    <div className="bg-gray-50 rounded-lg p-4">
                                                        <h4 className="font-semibold text-gray-800 mb-2">üìä Analysis Results</h4>
                                                        <p className="text-xs text-gray-600 mb-2">
                                                            Found {smartAnalysis.existingScenariosCount || 0} existing scenarios in {smartAnalysis.targetFile}
                                                        </p>
                                                        
                                                        {smartAnalysis.recommendations && smartAnalysis.recommendations.map((rec, idx) => (
                                                            <div key={idx} className={`text-sm py-1 px-2 rounded mb-1 ${
                                                                rec.type === 'suggestion' ? 'bg-blue-100 text-blue-800' :
                                                                rec.type === 'info' ? 'bg-yellow-100 text-yellow-800' :
                                                                'bg-green-100 text-green-800'
                                                            }`}>
                                                                {rec.type === 'suggestion' && 'üí°'} 
                                                                {rec.type === 'info' && '‚ÑπÔ∏è'} 
                                                                {rec.type === 'new' && '‚ú®'} {rec.message}
                                                            </div>
                                                        ))}
                                                    </div>
                                                    
                                                    {/* Scenarios to Extend */}
                                                    {smartAnalysis.extendExisting && smartAnalysis.extendExisting.length > 0 && (
                                                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                                            <h4 className="font-semibold text-blue-800 mb-2 flex items-center">
                                                                <span className="mr-2">üìù</span>
                                                                Extend Existing Scenarios ({smartAnalysis.extendExisting.length})
                                                            </h4>
                                                            <div className="space-y-2 max-h-40 overflow-y-auto">
                                                                {smartAnalysis.extendExisting.map((ext, idx) => (
                                                                    <div key={idx} className="bg-white p-2 rounded text-sm">
                                                                        <div className="font-medium text-blue-700">
                                                                            Add to: "{ext.targetScenario.name}"
                                                                        </div>
                                                                        <div className="text-gray-600 text-xs mt-1">
                                                                            + {ext.additionalSteps.length} step(s): {ext.additionalSteps.map(s => s.text).join(', ')}
                                                                        </div>
                                                                        <div className="text-blue-600 text-xs">{ext.reason}</div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                    
                                                    {/* New Scenarios */}
                                                    {smartAnalysis.newScenarios && smartAnalysis.newScenarios.length > 0 && (
                                                        <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                                                            <h4 className="font-semibold text-green-800 mb-2 flex items-center">
                                                                <span className="mr-2">‚ú®</span>
                                                                New Scenarios ({smartAnalysis.newScenarios.length})
                                                            </h4>
                                                            <div className="space-y-1 max-h-32 overflow-y-auto">
                                                                {smartAnalysis.newScenarios.map((s, idx) => (
                                                                    <div key={idx} className="text-sm text-green-700 bg-white p-1 rounded">
                                                                        {s.name}
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                    
                                                    {/* Skipped Duplicates */}
                                                    {smartAnalysis.skipDuplicates && smartAnalysis.skipDuplicates.length > 0 && (
                                                        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                                            <h4 className="font-semibold text-yellow-800 mb-2 flex items-center">
                                                                <span className="mr-2">‚è≠Ô∏è</span>
                                                                Skipped - Already Covered ({smartAnalysis.skipDuplicates.length})
                                                            </h4>
                                                            <div className="space-y-1 max-h-24 overflow-y-auto">
                                                                {smartAnalysis.skipDuplicates.map((s, idx) => (
                                                                    <div key={idx} className="text-xs text-yellow-700">
                                                                        <span className="font-medium">{s.scenario.name}</span>
                                                                        <span className="text-yellow-600"> - {s.reason}</span>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                    
                                                    {/* Apply Button */}
                                                    {(smartAnalysis.newScenarios?.length > 0 || smartAnalysis.extendExisting?.length > 0) && (
                                                        <button
                                                            onClick={handleApplySmartRecommendations}
                                                            disabled={saving}
                                                            className="w-full vulcan-button px-4 py-3 rounded-lg font-semibold flex items-center justify-center space-x-2"
                                                        >
                                                            {saving ? (
                                                                <>
                                                                    <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                                                    <span>Applying changes...</span>
                                                                </>
                                                            ) : (
                                                                <>
                                                                    <span>üöÄ</span>
                                                                    <span>Apply Smart Recommendations</span>
                                                                </>
                                                            )}
                                                        </button>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                    
                                    {/* Manual Options (when Smart Mode is off) */}
                                    {!useSmartMode && (
                                        <>
                                            {/* Option 1: Add to Existing */}
                                            <div className="mb-6 pb-6 border-b border-gray-200">
                                                <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                    Option 1: Add Selected to Existing Feature File
                                                </label>
                                                <div className="flex space-x-2">
                                                    <button
                                                        onClick={handleAddToExisting}
                                                        className="vulcan-button px-4 py-2 rounded-lg font-semibold"
                                                        disabled={!selectedModule || saving || selectedScenarios.size === 0}
                                                    >
                                                        {saving ? 'Saving...' : `Add ${selectedScenarios.size} Scenario${selectedScenarios.size !== 1 ? 's' : ''} to File`}
                                                    </button>
                                                </div>
                                            </div>

                                            {/* Option 2: Create New */}
                                            <div>
                                                <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                    Option 2: Create New Feature File
                                                </label>
                                                <div className="flex space-x-2">
                                                    <input
                                                        type="text"
                                                        value={newFeatureFileName}
                                                        onChange={(e) => setNewFeatureFileName(e.target.value)}
                                                        placeholder="e.g., new-checkout-flow"
                                                        className="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-700"
                                                    />
                                                    <span className="self-center text-gray-500">.feature</span>
                                                    <button
                                                        onClick={handleCreateNewFeature}
                                                        className="vulcan-button px-4 py-2 rounded-lg font-semibold"
                                                        disabled={!newFeatureFileName.trim() || saving || selectedScenarios.size === 0}
                                                    >
                                                        {saving ? 'Creating...' : `Create with ${selectedScenarios.size} Scenario${selectedScenarios.size !== 1 ? 's' : ''}`}
                                                    </button>
                                                </div>
                                            </div>
                                        </>
                                    )}

                                    {/* Save Result */}
                                    {saveResult && (
                                        <div className={`mt-4 p-4 rounded-lg ${saveResult.success ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}`}>
                                            {saveResult.success ? (
                                                <div className="text-green-800">
                                                    <span className="font-semibold">‚úÖ Success!</span>
                                                    <p className="text-sm mt-1">{saveResult.message}</p>
                                                    {saveResult.filePath && (
                                                        <p className="text-xs text-green-600 mt-1">File: {saveResult.filePath}</p>
                                                    )}
                                                </div>
                                            ) : (
                                                <div className="text-red-800">
                                                    <span className="font-semibold">‚ùå Error</span>
                                                    <p className="text-sm mt-1">{saveResult.error}</p>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* Step Definition Section - Show after successful save */}
                                    {saveResult && saveResult.success && (
                                        <div className="mt-6 bg-white rounded-xl shadow-md p-6">
                                            <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                                <span className="mr-2">üìã</span> Step Definitions
                                            </h3>
                                            
                                            {/* Check Step Definitions Button */}
                                            <button
                                                onClick={handleCheckStepDefinitions}
                                                disabled={checkingStepDefs}
                                                className="w-full bg-indigo-600 text-white px-4 py-3 rounded-lg hover:bg-indigo-700 transition-all font-semibold flex items-center justify-center space-x-2"
                                            >
                                                {checkingStepDefs ? (
                                                    <>
                                                        <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                                        <span>Analyzing Step Definitions...</span>
                                                    </>
                                                ) : (
                                                    <>
                                                        <span>üîç</span>
                                                        <span>Check Existing Step Definitions</span>
                                                    </>
                                                )}
                                            </button>

                                            {/* Step Definition Results */}
                                            {stepDefResults && (
                                                <div className="mt-4">
                                                    {/* Existing Steps */}
                                                    {stepDefResults.foundSteps && stepDefResults.foundSteps.length > 0 && (
                                                        <div className="mb-4">
                                                            <h4 className="text-sm font-semibold text-green-700 mb-2 flex items-center">
                                                                <span className="mr-1">‚úÖ</span> Existing Step Definitions ({stepDefResults.foundSteps.length})
                                                            </h4>
                                                            <div className="bg-green-50 border border-green-200 rounded-lg p-3 max-h-40 overflow-y-auto">
                                                                {stepDefResults.foundSteps.map((step, idx) => (
                                                                    <div key={idx} className="text-xs text-green-800 py-1 border-b border-green-100 last:border-b-0">
                                                                        <code>{step.step}</code>
                                                                        <span className="text-green-600 ml-2 text-xs">‚Üí {step.file}</span>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}

                                                    {/* Missing Steps */}
                                                    {stepDefResults.missingSteps && stepDefResults.missingSteps.length > 0 && (
                                                        <div className="mb-4">
                                                            <h4 className="text-sm font-semibold text-orange-700 mb-2 flex items-center">
                                                                <span className="mr-1">‚ö†Ô∏è</span> Missing Step Definitions ({stepDefResults.missingSteps.length})
                                                            </h4>
                                                            <div className="bg-orange-50 border border-orange-200 rounded-lg p-3 max-h-40 overflow-y-auto">
                                                                {stepDefResults.missingSteps.map((step, idx) => (
                                                                    <div key={idx} className="text-xs text-orange-800 py-1 border-b border-orange-100 last:border-b-0">
                                                                        <code>{step.step}</code>
                                                                    </div>
                                                                ))}
                                                            </div>

                                                            {/* Generate Step Definitions Button */}
                                                            <button
                                                                onClick={handleGenerateStepDefinitions}
                                                                disabled={generatingStepDefs}
                                                                className="mt-3 w-full bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-all font-semibold flex items-center justify-center space-x-2"
                                                            >
                                                                {generatingStepDefs ? (
                                                                    <>
                                                                        <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                                                        <span>Generating Code...</span>
                                                                    </>
                                                                ) : (
                                                                    <>
                                                                        <span>‚ö°</span>
                                                                        <span>Generate Missing Step Definitions</span>
                                                                    </>
                                                                )}
                                                            </button>
                                                        </div>
                                                    )}

                                                    {/* All steps exist message */}
                                                    {stepDefResults.missingSteps && stepDefResults.missingSteps.length === 0 && (
                                                        <div className="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                                                            <span className="text-2xl">üéâ</span>
                                                            <p className="text-green-700 font-semibold mt-1">All step definitions already exist!</p>
                                                            <p className="text-green-600 text-sm">Your scenarios are ready to run.</p>
                                                        </div>
                                                    )}
                                                </div>
                                            )}

                                            {/* Generated Step Definition Code */}
                                            {generatedStepDefs && generatedStepDefs.success && (
                                                <div className="mt-4">
                                                    <h4 className="text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                                        <span className="mr-1">üìù</span> Generated Step Definition Code
                                                    </h4>
                                                    <div className="bg-gray-900 rounded-lg p-4 overflow-x-auto">
                                                        <pre className="text-xs text-green-400 whitespace-pre-wrap font-mono">{generatedStepDefs.code}</pre>
                                                    </div>
                                                    <div className="mt-3 flex space-x-2">
                                                        <button
                                                            onClick={() => {
                                                                navigator.clipboard.writeText(generatedStepDefs.code);
                                                                alert('Code copied to clipboard!');
                                                            }}
                                                            className="flex-1 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-all text-sm font-semibold"
                                                        >
                                                            üìã Copy Code
                                                        </button>
                                                    </div>
                                                    <p className="mt-2 text-xs text-gray-500">
                                                        Add this code to: <code className="bg-gray-100 px-1 rounded">Ecomm/features/step_definitions/{generatedStepDefs.fileName}</code>
                                                    </p>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </>
                        ) : (
                            <div className="bg-white rounded-xl shadow-md p-12 text-center">
                                <div className="text-6xl mb-4">‚ú®</div>
                                <h3 className="text-lg font-semibold text-gray-700 mb-2">No Scenarios Yet</h3>
                                <p className="text-gray-500 text-sm">
                                    Enter a Jira story, epic, or filter on the left to generate test scenarios
                                </p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // ============ DEFECT LOGGER TAB COMPONENT ============
        function DefectLoggerTab() {
            const [formData, setFormData] = useState({
                summary: '',
                description: '',
                module: '',
                priority: 'P2',
                screenshot: null
            });
            const [modules, setModules] = useState([]);
            const [submitting, setSubmitting] = useState(false);
            const [defects, setDefects] = useState([]);

            useEffect(() => {
                loadModules();
            }, []);

            const loadModules = async () => {
                try {
                    const response = await fetch(`${API_BASE}/modules`);
                    const data = await response.json();
                    setModules(data.modules || []);
                } catch (error) {
                    console.error('Error loading modules:', error);
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setSubmitting(true);

                // TODO: Implement Jira defect creation endpoint
                setTimeout(() => {
                    const newDefect = {
                        id: Date.now(),
                        ...formData,
                        status: 'created',
                        jiraId: `SHOP-${Math.floor(Math.random() * 10000)}`,
                        createdAt: new Date()
                    };
                    setDefects([newDefect, ...defects]);
                    setFormData({
                        summary: '',
                        description: '',
                        module: '',
                        priority: 'P2',
                        screenshot: null
                    });
                    setSubmitting(false);
                    alert('Defect created successfully! (Demo mode - Jira integration coming soon)');
                }, 1500);
            };

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setFormData({ ...formData, screenshot: file });
                }
            };

            return (
                <div className="max-w-6xl mx-auto px-6 py-8">
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* Defect Creation Form */}
                        <div>
                            <div className="bg-white rounded-xl shadow-md overflow-hidden">
                                <div className="bg-gradient-to-r from-vulcan-blue to-vulcan-light-blue text-white px-6 py-4">
                                    <h2 className="text-xl font-bold">Create Defect</h2>
                                </div>
                                <form onSubmit={handleSubmit} className="p-6">
                                    <div className="space-y-4">
                                        <div>
                                            <label className="text-xs text-gray-500 font-semibold mb-1 block">SUMMARY *</label>
                                            <input
                                                type="text"
                                                value={formData.summary}
                                                onChange={(e) => setFormData({...formData, summary: e.target.value})}
                                                className="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-700"
                                                placeholder="Brief description of the issue"
                                                required
                                            />
                                        </div>

                                        <div>
                                            <label className="text-xs text-gray-500 font-semibold mb-1 block">DESCRIPTION *</label>
                                            <textarea
                                                value={formData.description}
                                                onChange={(e) => setFormData({...formData, description: e.target.value})}
                                                className="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-700"
                                                rows="4"
                                                placeholder="Detailed steps to reproduce, expected vs actual results"
                                                required
                                            />
                                        </div>

                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="text-xs text-gray-500 font-semibold mb-1 block">MODULE *</label>
                                                <select
                                                    value={formData.module}
                                                    onChange={(e) => setFormData({...formData, module: e.target.value})}
                                                    className="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-700"
                                                    required
                                                >
                                                    <option value="">Select module</option>
                                                    {modules.map(mod => (
                                                        <option key={mod.id} value={mod.id}>{mod.name}</option>
                                                    ))}
                                                </select>
                                            </div>

                                            <div>
                                                <label className="text-xs text-gray-500 font-semibold mb-1 block">PRIORITY</label>
                                                <select
                                                    value={formData.priority}
                                                    onChange={(e) => setFormData({...formData, priority: e.target.value})}
                                                    className="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-700"
                                                >
                                                    <option value="P1">P1 - Critical</option>
                                                    <option value="P2">P2 - High</option>
                                                    <option value="P3">P3 - Medium</option>
                                                    <option value="P4">P4 - Low</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div>
                                            <label className="text-xs text-gray-500 font-semibold mb-1 block">SCREENSHOT</label>
                                            <input
                                                type="file"
                                                accept="image/*"
                                                onChange={handleFileChange}
                                                className="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-700"
                                            />
                                            {formData.screenshot && (
                                                <div className="mt-2 text-sm text-gray-600">
                                                    Selected: {formData.screenshot.name}
                                                </div>
                                            )}
                                        </div>

                                        <button
                                            type="submit"
                                            className="w-full vulcan-button px-6 py-3 rounded-lg font-semibold"
                                            disabled={submitting}
                                        >
                                            {submitting ? (
                                                <div className="flex items-center justify-center space-x-2">
                                                    <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                                    <span>Creating Defect...</span>
                                                </div>
                                            ) : (
                                                'Create Jira Defect'
                                            )}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        {/* Recent Defects */}
                        <div>
                            <div className="bg-white rounded-xl shadow-md overflow-hidden">
                                <div className="bg-gradient-to-r from-vulcan-blue to-vulcan-light-blue text-white px-6 py-4">
                                    <h2 className="text-xl font-bold">Recent Defects</h2>
                                </div>
                                <div className="p-6">
                                    {defects.length === 0 ? (
                                        <div className="text-center py-12 text-gray-500">
                                            <div className="text-5xl mb-4">‚ö†</div>
                                            <p>No defects logged yet</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            {defects.map(defect => (
                                                <div key={defect.id} className="border border-gray-200 rounded-lg p-4">
                                                    <div className="flex items-start justify-between mb-2">
                                                        <div className="flex-1">
                                                            <div className="text-sm font-semibold text-gray-800 mb-1">
                                                                {defect.summary}
                                                            </div>
                                                            <div className="text-xs text-gray-500 mb-2">
                                                                {defect.jiraId} ‚Ä¢ {defect.module} ‚Ä¢ {defect.priority}
                                                            </div>
                                                            <div className="text-xs text-gray-600">
                                                                {defect.createdAt.toLocaleString()}
                                                            </div>
                                                        </div>
                                                        <span className="status-badge status-passed">{defect.status.toUpperCase()}</span>
                                                    </div>
                                                    <div className="mt-2 text-sm text-gray-600 line-clamp-2">
                                                        {defect.description}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // ============ EXECUTION PANEL COMPONENT ============
        function ExecutionPanel({ executionId, onClose, fullScreen }) {
            const [logs, setLogs] = useState([]);
            const [status, setStatus] = useState('running');
            const [executionInfo, setExecutionInfo] = useState(null);
            const [currentScenario, setCurrentScenario] = useState('');
            const logsEndRef = useRef(null);

            // Fetch execution info including scenario names
            useEffect(() => {
                const fetchExecutionInfo = async () => {
                    try {
                        const response = await fetch(`${API_BASE}/tests/execution/${executionId}`);
                        const data = await response.json();
                        setExecutionInfo(data);
                    } catch (error) {
                        console.error('Error fetching execution info:', error);
                    }
                };
                fetchExecutionInfo();
                // Poll for updates every 2 seconds while running
                const interval = setInterval(() => {
                    if (status === 'running') {
                        fetchExecutionInfo();
                    }
                }, 2000);
                return () => clearInterval(interval);
            }, [executionId, status]);

            useEffect(() => {
                // Connect to SSE stream
                const eventSource = new EventSource(`${API_BASE}/tests/execution/${executionId}/stream`);

                eventSource.addEventListener('message', (event) => {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'complete') {
                        setStatus(data.status);
                        eventSource.close();
                        // Dispatch event to notify other components (Analytics, Executive Report)
                        window.dispatchEvent(new CustomEvent('executionComplete', { 
                            detail: { executionId, status: data.status } 
                        }));
                    } else if (data.type !== 'connected') {
                        setLogs(prev => [...prev, data]);
                        // Detect scenario/step info from log
                        if (data.message) {
                            // Look for Scenario: pattern
                            if (data.message.includes('Scenario:')) {
                                const match = data.message.match(/Scenario:\s*(.+)/);
                                if (match) setCurrentScenario(match[1].trim());
                            }
                            // Look for common step patterns (‚úì indicates completed step)
                            else if (data.message.startsWith('‚úì ') || data.message.includes('...')) {
                                // Extract step description
                                const stepMatch = data.message.match(/(?:‚úì\s+)?(.+?)(?:\.\.\.|$)/);
                                if (stepMatch && stepMatch[1].length > 10) {
                                    setCurrentScenario(stepMatch[1].trim());
                                }
                            }
                            // Look for "Navigating to" patterns
                            else if (data.message.match(/^(Navigating|Clicking|Verifying|Checking|Hovering|Setting|Adding)/)) {
                                setCurrentScenario(data.message.replace('...', '').trim());
                            }
                        }
                    }
                });

                eventSource.onerror = () => {
                    console.error('SSE connection error');
                    eventSource.close();
                };

                return () => eventSource.close();
            }, [executionId]);

            useEffect(() => {
                logsEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [logs]);

            const stopExecution = async () => {
                await fetch(`${API_BASE}/tests/execution/${executionId}/stop`, { method: 'POST' });
                setStatus('stopped');
            };

            if (fullScreen) {
                // Full screen mode for Execution tab
                return (
                    <div className="h-full flex flex-col bg-white">
                        {/* Header */}
                        <div className="vulcan-gradient text-white p-6">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h2 className="text-2xl font-bold">Test Execution</h2>
                                    <p className="text-gray-300 mt-1">Execution ID: {executionId}</p>
                                </div>
                                <div className="flex items-center space-x-3">
                                    <div className={`flex items-center space-x-2 px-4 py-2 rounded-lg border ${
                                        status === 'running' ? 'bg-yellow-500/20 border-yellow-500' :
                                        status === 'passed' ? 'bg-green-500/20 border-green-500' :
                                        'bg-red-500/20 border-red-500'
                                    }`}>
                                        {status === 'running' && <div className="w-2 h-2 bg-yellow-400 rounded-full pulse-dot"></div>}
                                        <span className="font-semibold capitalize text-white">{status}</span>
                                    </div>
                                    <button 
                                        onClick={stopExecution} 
                                        disabled={status !== 'running'}
                                        className={`px-4 py-2 rounded-lg font-semibold transition-colors ${
                                            status === 'running' 
                                                ? 'bg-red-500 hover:bg-red-600 cursor-pointer' 
                                                : 'bg-gray-400 cursor-not-allowed opacity-50'
                                        }`}>
                                        STOP
                                    </button>
                                </div>
                            </div>
                            {/* Current Scenario Display */}
                            {status === 'running' && currentScenario && (
                                <div className="mt-4 bg-blue-500/20 border border-blue-400 rounded-lg p-3">
                                    <div className="flex items-center space-x-2">
                                        <div className="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></div>
                                        <span className="text-blue-200 text-sm font-medium">Currently Running:</span>
                                        <span className="text-white font-semibold">{currentScenario}</span>
                                    </div>
                                </div>
                            )}
                            {/* Execution Summary */}
                            {executionInfo && executionInfo.scenarioNames && executionInfo.scenarioNames.length > 0 && (
                                <div className="mt-3 text-gray-300 text-sm">
                                    <span>Total Scenarios: {executionInfo.scenarioNames.length}</span>
                                    {executionInfo.tags && <span className="ml-4">Tags: {executionInfo.tags}</span>}
                                </div>
                            )}
                        </div>

                        {/* Logs */}
                        <div className="flex-1 bg-gray-900 p-6 overflow-y-auto">
                            <div className="space-y-1">
                                {logs.map((log, idx) => (
                                    <div key={idx} className={`log-line ${
                                        log.type === 'stderr' ? 'text-red-400' : 'text-green-400'
                                    }`}>
                                        {log.message}
                                    </div>
                                ))}
                                <div ref={logsEndRef} />
                            </div>
                        </div>
                    </div>
                );
            }

            // Modal mode for inline execution
            return (
                <div className="fixed inset-0 bg-black/50 modal-backdrop flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl max-w-6xl w-full max-h-[90vh] overflow-hidden shadow-2xl">
                        {/* Header */}
                        <div className="vulcan-gradient text-white p-6">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h2 className="text-2xl font-bold">Test Execution</h2>
                                    <p className="text-gray-300 mt-1">Execution ID: {executionId}</p>
                                </div>
                                <div className="flex items-center space-x-3">
                                    <div className={`flex items-center space-x-2 px-4 py-2 rounded-lg border ${
                                        status === 'running' ? 'bg-yellow-500/20 border-yellow-500' :
                                        status === 'passed' ? 'bg-green-500/20 border-green-500' :
                                        'bg-red-500/20 border-red-500'
                                    }`}>
                                        {status === 'running' && <div className="w-2 h-2 bg-yellow-400 rounded-full pulse-dot"></div>}
                                        <span className="font-semibold capitalize text-white">{status}</span>
                                    </div>
                                    <button 
                                        onClick={stopExecution} 
                                        disabled={status !== 'running'}
                                        className={`px-4 py-2 rounded-lg font-semibold transition-colors ${
                                            status === 'running' 
                                                ? 'bg-red-500 hover:bg-red-600 cursor-pointer' 
                                                : 'bg-gray-400 cursor-not-allowed opacity-50'
                                        }`}>
                                        STOP
                                    </button>
                                    {onClose && (
                                        <button onClick={onClose} 
                                                className="text-white hover:bg-white/20 rounded-lg p-2 transition-colors">
                                            <span className="text-2xl">√ó</span>
                                        </button>
                                    )}
                                </div>
                            </div>
                            {/* Current Scenario Display */}
                            {status === 'running' && currentScenario && (
                                <div className="mt-4 bg-blue-500/20 border border-blue-400 rounded-lg p-3">
                                    <div className="flex items-center space-x-2">
                                        <div className="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></div>
                                        <span className="text-blue-200 text-sm font-medium">Currently Running:</span>
                                        <span className="text-white font-semibold">{currentScenario}</span>
                                    </div>
                                </div>
                            )}
                            {/* Execution Summary */}
                            {executionInfo && executionInfo.scenarioNames && executionInfo.scenarioNames.length > 0 && (
                                <div className="mt-3 text-gray-300 text-sm">
                                    <span>Total Scenarios: {executionInfo.scenarioNames.length}</span>
                                    {executionInfo.tags && <span className="ml-4">Tags: {executionInfo.tags}</span>}
                                </div>
                            )}
                        </div>

                        {/* Logs */}
                        <div className="bg-gray-900 p-6 overflow-y-auto" style={{maxHeight: '70vh'}}>
                            <div className="space-y-1">
                                {logs.map((log, idx) => (
                                    <div key={idx} className={`log-line ${
                                        log.type === 'stderr' ? 'text-red-400' : 'text-green-400'
                                    }`}>
                                        {log.message}
                                    </div>
                                ))}
                                <div ref={logsEndRef} />
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // ============ MAIN APP COMPONENT ============
        function App() {
            const [activeTab, setActiveTab] = useState('modules');
            const [modules, setModules] = useState([]);
            const [stats, setStats] = useState(null);
            const [loading, setLoading] = useState(true);
            const [selectedModule, setSelectedModule] = useState(null);
            const [executionId, setExecutionId] = useState(null);

            useEffect(() => {
                loadData();
                
                // Listen for execution start events
                const handleExecutionStart = (event) => {
                    setExecutionId(event.detail);
                    setActiveTab('execution');
                };
                
                window.addEventListener('startExecution', handleExecutionStart);
                
                return () => {
                    window.removeEventListener('startExecution', handleExecutionStart);
                };
            }, []);

            useEffect(() => {
                if (activeTab === 'modules' && modules.length === 0) {
                    loadData();
                }
            }, [activeTab]);

            const loadData = async () => {
                try {
                    const [modulesRes, statsRes] = await Promise.all([
                        fetch(`${API_BASE}/modules`),
                        fetch(`${API_BASE}/modules/stats`)
                    ]);

                    const modulesData = await modulesRes.json();
                    const statsData = await statsRes.json();

                    setModules(modulesData.modules);
                    setStats(statsData);
                } catch (error) {
                    console.error('Error loading data:', error);
                } finally {
                    setLoading(false);
                }
            };

            const handleRunTests = async (module) => {
                try {
                    const response = await fetch(`${API_BASE}/tests/run`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            modules: [module.id],
                            headless: true
                        })
                    });

                    const data = await response.json();
                    setExecutionId(data.executionId);
                    setActiveTab('execution');
                } catch (error) {
                    console.error('Error starting tests:', error);
                    alert('Failed to start test execution');
                }
            };

            const handleRunSelected = async (moduleId, scenarios) => {
                try {
                    const response = await fetch(`${API_BASE}/tests/run`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            modules: [moduleId],
                            headless: true,
                            selectedScenarios: { [moduleId]: scenarios }
                        })
                    });

                    const data = await response.json();
                    setExecutionId(data.executionId);
                    setActiveTab('execution');
                } catch (error) {
                    console.error('Error starting tests:', error);
                    alert('Failed to start test execution');
                }
            };

            return (
                <div className="flex h-screen bg-gray-50">
                    {/* Sidebar */}
                    <Sidebar activeTab={activeTab} onTabChange={setActiveTab} />

                    {/* Main Content */}
                    <div className="flex-1 flex flex-col overflow-hidden">
                        {/* Header */}
                        <Header />

                        {/* Content Area */}
                        <main className="flex-1 overflow-y-auto">
                            {activeTab === 'modules' && (
                                <ModulesTab 
                                    modules={modules}
                                    stats={stats}
                                    loading={loading}
                                    onRunTests={handleRunTests}
                                    onViewScenarios={setSelectedModule}
                                />
                            )}

                            {activeTab === 'execution' && (
                                <ExecutionTab executionId={executionId} />
                            )}

                            {activeTab === 'analytics' && (
                                <AnalyticsTab />
                            )}

                            {activeTab === 'report' && (
                                <ExecutiveReportTab />
                            )}

                            {activeTab === 'ai' && (
                                <AICommanderTab />
                            )}

                            {activeTab === 'ai-features' && (
                                <AIFeatureGeneratorTab />
                            )}

                            {activeTab === 'defects' && (
                                <DefectLoggerTab />
                            )}
                        </main>
                    </div>

                    {/* Modals */}
                    {selectedModule && (
                        <ScenarioModal 
                            module={selectedModule}
                            onClose={() => setSelectedModule(null)}
                            onRun={handleRunSelected}
                        />
                    )}
                </div>
            );
        }

        // Render App
        ReactDOM.render(<App />, document.getElementById('app'));
    </script>
</body>
</html>
